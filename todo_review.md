# `todo.txt` 审查报告

## 总结
该方案在功能层面覆盖较全（订阅管理、在线编辑、日志、备份），但默认形态不适合直接公网部署。主要问题集中在认证缺失、可远程改脚本并执行、网络暴露面过大。若按文档“原样落地”，存在被接管风险。

## 发现（按严重程度）

### 1) 严重：管理 API 缺少认证与权限控制，且对外暴露
- 证据:
  - `todo.txt:79` 映射 `80:80` 对外提供面板与 API。
  - `todo.txt:145` 到 `todo.txt:150` 将 `/api/` 反代到 Flask。
  - `todo.txt:252` 使用 `CORS(app)`，未见 origin 白名单或鉴权中间件。
  - `todo.txt:919` `app.run(host='0.0.0.0', port=9092, ...)`。
  - `todo.txt:1597` 到 `todo.txt:1607` 前端请求未携带任何认证令牌。
- 影响:
  - 任意访问者可调用管理接口，读取配置、改写配置、触发合并/重载、操作备份。
- 建议:
  - 强制认证（至少 `Authorization: Bearer <token>` 或网关级 OIDC/BasicAuth）。
  - API 按角色拆分读写权限（只读状态接口与高危写接口分离）。
  - `CORS` 改为显式白名单域名，不允许 `*`。

### 2) 严重：存在“远程改脚本并执行”的 RCE 链路
- 证据:
  - `todo.txt:847` 定义 `merge_script` 可编辑。
  - `todo.txt:879` 到 `todo.txt:913` 的 `/api/files/<key>` 支持保存 `.py` 文件。
  - `todo.txt:579` 到 `todo.txt:596` `/api/merge-script` 可直接改 `merge.py`。
  - `todo.txt:644` 到 `todo.txt:677` `/api/actions/merge` 会执行 `merge.py`。
- 影响:
  - 一旦 API 被未授权访问，可直接执行任意 Python 代码，进而控制容器。
- 建议:
  - 生产环境禁用在线脚本编辑接口（尤其 `.py`）。
  - 合并执行改为固定二进制或受限子进程，禁止从可写路径执行脚本。
  - 将容器降权运行（非 root、只读文件系统、最小权限挂载）。

### 3) 高：端口暴露面过大，容易绕过后续防护
- 证据:
  - `todo.txt:76` 到 `todo.txt:79` 同时暴露 `7890/7891/9090/80`。
  - `todo.txt:171` 到 `todo.txt:176` 再次通过 `/clash-api/` 代理到 9090。
  - `todo.txt:86` 示例 Secret 为占位值 `your_secret_here`。
- 影响:
  - 既有直连端口又有反代入口，后续若仅在 Nginx 增加认证，直连端口仍可绕过。
- 建议:
  - 默认只开放 `80/443`，`9090` 保持容器内网可见。
  - 强制要求部署时设置强随机 Secret，启动时校验占位值并拒绝启动。

### 4) 高：订阅测试接口可被用于 SSRF
- 证据:
  - `todo.txt:460` 到 `todo.txt:463` 对用户提供的 URL 直接 `requests.get(...)`。
- 影响:
  - 可探测/访问内网地址、云元数据地址，形成横向信息泄露风险。
- 建议:
  - 对目标 URL 做协议和网段限制（仅 `http/https`，拒绝私网与环回地址）。
  - 增加 DNS 重绑定防护与请求超时/大小限制。

### 5) 中：文件名与路径边界校验不足
- 证据:
  - `todo.txt:404` 到 `todo.txt:408` 订阅重命名时将 `new_name` 直接拼入路径。
  - `todo.txt:740` 与 `todo.txt:753` 备份恢复/删除将路由参数直接拼接为文件路径。
- 影响:
  - 在缺少严格校验时，可能引入目录穿越或误操作非目标文件风险。
- 建议:
  - 文件名使用白名单正则（如 `^[A-Za-z0-9._-]{1,64}$`）。
  - 所有路径操作使用 `resolve()` 并校验必须位于预期目录下。

### 6) 中：进程守护与可用性设计不足
- 证据:
  - `todo.txt:197` 启动 `nginx`，`todo.txt:200` 将 API 后台启动，`todo.txt:205` 仅 `exec mihomo`。
  - 文档中未见 `healthcheck` 与进程监督策略。
- 影响:
  - Flask 或 Nginx 异常退出后容器可能仍存活但功能部分失效，难以及时恢复。
- 建议:
  - 使用进程监督器（如 `s6/supervisord`）或拆分成多容器。
  - 添加 `healthcheck` 与重启策略，明确故障探测信号。

### 7) 中：供应链不可复现，缺少版本与完整性校验
- 证据:
  - `todo.txt:106` 到 `todo.txt:116` 构建阶段直接下载 `latest` 发布物。
- 影响:
  - 构建结果不可复现，且缺少 checksum/signature 校验带来供应链风险。
- 建议:
  - 固定版本号并校验 SHA256/签名。
  - 使用内部镜像仓库或受控制品源。

## 修订优先级建议
1. 先做安全封堵: 认证、禁用脚本在线编辑、收敛端口、CORS 白名单。
2. 再做执行面治理: SSRF 防护、路径白名单、最小权限运行。
3. 最后做稳定性与工程化: 进程监督、健康检查、版本锁定与校验、验收测试。
