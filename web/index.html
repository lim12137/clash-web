<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Clash 内网管理面板</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <header class="topbar">
    <div>
      <h1>Clash 管理面板</h1>
      <p>内网单机 · 局域网代理共享</p>
    </div>
    <div class="status-area">
      <span id="clash-status" class="badge">检查中</span>
      <span id="clash-version" class="muted">-</span>
    </div>
  </header>

  <main class="grid">
    <section class="card">
      <h2>管理访问</h2>
      <div class="row">
        <input id="admin-token" type="password" placeholder="ADMIN_TOKEN (可选)">
        <button id="save-token">保存令牌</button>
      </div>
      <p class="muted">未设置令牌时，写操作默认开放给内网访问者。</p>
    </section>

    <section class="card">
      <h2>运行操作</h2>
      <div class="row wrap">
        <button id="btn-merge">仅合并</button>
        <button id="btn-merge-reload">合并并重载</button>
        <button id="btn-reload">仅重载</button>
        <button id="btn-refresh">刷新状态</button>
      </div>
    </section>

    <section class="card">
      <h2>定时任务</h2>
      <div class="row wrap">
        <label class="check">
          <input type="checkbox" id="schedule-enabled">
          启用定时合并重载
        </label>
        <label class="check">
          间隔(分钟)
          <input id="schedule-interval" type="number" min="5" max="1440" value="60" style="width: 90px;">
        </label>
        <button id="save-schedule">保存计划</button>
      </div>
      <p id="schedule-info" class="muted">计划状态: -</p>
    </section>

    <section class="card wide">
      <div class="section-title">
        <h2>定时执行历史</h2>
        <div class="row">
          <button id="reload-schedule-history">刷新历史</button>
          <button id="clear-schedule-history">清空历史</button>
        </div>
      </div>
      <div class="row wrap history-filters">
        <label class="check">
          <input type="checkbox" id="history-only-scheduler">
          仅 scheduler
        </label>
        <label class="check">
          <input type="checkbox" id="history-only-failed">
          仅失败
        </label>
        <span id="schedule-history-count" class="muted">显示 0 / 0</span>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>开始</th>
              <th>结束</th>
              <th>触发</th>
              <th>动作</th>
              <th>状态</th>
              <th>说明</th>
            </tr>
          </thead>
          <tbody id="schedule-history-table"></tbody>
        </table>
      </div>
    </section>

    <section class="card wide">
      <div class="section-title">
        <h2>订阅管理</h2>
        <button id="reload-subs">刷新订阅</button>
      </div>
      <form id="sub-form" class="sub-form">
        <input type="hidden" id="sub-original-name">
        <input id="sub-name" placeholder="名称（字母数字._-）" required>
        <input id="sub-url" placeholder="订阅地址 https://..." required>
        <input id="sub-prefix" placeholder="前缀，例如 HK_">
        <input id="sub-include" placeholder="包含正则（可空）">
        <input id="sub-exclude" placeholder="排除正则（可空）">
        <label class="check">
          <input type="checkbox" id="sub-enabled" checked>
          启用
        </label>
        <button type="submit">保存订阅</button>
        <button type="button" id="sub-reset">清空表单</button>
      </form>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>名称</th>
              <th>状态</th>
              <th>节点数</th>
              <th>缓存时间</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="sub-table"></tbody>
        </table>
      </div>
    </section>

    <section class="card wide">
      <div class="section-title">
        <h2>订阅集合（自动写入 override.js 头部）</h2>
        <button id="save-sub-sets">保存集合</button>
      </div>
      <p class="muted">集合1=付费，集合2=免费。支持新增、删除行，以及批量粘贴导入（每行：名称,URL）。保存后自动写入脚本头部。</p>
      <div class="set-grid">
        <div class="set-panel">
          <div class="section-title">
            <h3>集合1（付费）</h3>
            <div class="row">
              <button id="add-set1-row">新增行</button>
              <button id="import-set1-bulk">批量导入</button>
            </div>
          </div>
          <div class="table-wrap">
            <table class="mini-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>名称</th>
                  <th>URL</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="set1-table"></tbody>
            </table>
          </div>
        </div>
        <div class="set-panel">
          <div class="section-title">
            <h3>集合2（免费）</h3>
            <div class="row">
              <button id="add-set2-row">新增行</button>
              <button id="import-set2-bulk">批量导入</button>
            </div>
          </div>
          <div class="table-wrap">
            <table class="mini-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>名称</th>
                  <th>URL</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="set2-table"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section class="card wide">
      <div class="section-title">
        <h2>节点切换</h2>
        <button id="reload-groups">刷新组</button>
      </div>
      <div id="groups-list" class="groups"></div>
    </section>

    <section class="card wide">
      <div class="section-title">
        <h2>配置编辑</h2>
        <div class="row">
          <button class="tab active" data-tab="override-script">override.js</button>
          <button class="tab" data-tab="override">override.yaml</button>
          <button class="tab" data-tab="site-policy">site_policy.yaml</button>
          <button class="tab" data-tab="merge-script">merge.py</button>
        </div>
      </div>
      <textarea id="editor" spellcheck="false"></textarea>
      <div class="row">
        <button id="btn-load-editor">重新加载</button>
        <button id="btn-save-editor">保存当前</button>
      </div>
    </section>

    <section class="card wide">
      <div class="section-title">
        <h2>运行日志</h2>
        <button id="clear-logs">清空显示</button>
      </div>
      <pre id="logs" class="logs"></pre>
    </section>
  </main>

  <div id="bulk-import-modal" class="modal hidden">
    <div class="modal-card">
      <div class="section-title">
        <h3 id="bulk-import-title">批量导入</h3>
        <button type="button" id="bulk-import-cancel">取消</button>
      </div>
      <p class="muted">每行格式：名称,URL。支持空行，空行会自动忽略。</p>
      <textarea id="bulk-import-text" spellcheck="false" placeholder="例如：&#10;HK Premium,https://example.com/subA&#10;JP Free,https://example.com/subB"></textarea>
      <div class="row">
        <button type="button" id="bulk-import-submit">导入到当前集合</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>
  <script src="/app.js"></script>
</body>
</html>
