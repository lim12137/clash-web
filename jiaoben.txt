// ==================== è®¢é˜…åœ°å€ ====================
const SUB_A_URL = "http://49.233.252.141:33666/s/a8c260a412e05afda443a15718e7841c";
const SUB_B_URL = "https://sss.xlajiao.xyz/user/profile/data/644f13d6046ad51e53dd561e2d4cf686";
const SUB_C_URL = "https://gh-proxy.org/https://raw.githubusercontent.com/Jsnzkpg/Jsnzkpg/Jsnzkpg/Jsnzkpg";

// ==================== è¿‡æ»¤å™¨ ====================
const US_FILTER =
  "(?i)(ğŸ‡ºğŸ‡¸|\\bUS\\b|United States|America|ç¾å›½|ç¾è¥¿|ç¾ä¸œ|æ´›æ‰çŸ¶|åœ£ä½•å¡|ç¡…è°·|è¥¿é›…å›¾|è¾¾æ‹‰æ–¯|èŠåŠ å“¥|çº½çº¦|åç››é¡¿)";

// ==================== å·¥å…·å‡½æ•° ====================
function upsertGroup(groups, groupObj) {
  const idx = groups.findIndex((g) => g && g.name === groupObj.name);
  if (idx >= 0) groups[idx] = groupObj;
  else groups.push(groupObj);
}

function setRules(config, rules) {
  // å®Œå…¨æ›¿æ¢è§„åˆ™åˆ—è¡¨ï¼Œé¿å…ä¸åŸæœ‰è§„åˆ™å†²çª
  config.rules = rules;
}

// ==================== ä¸»å‡½æ•° ====================
const main = (config) => {
  config ??= {};
  config.mode = "rule";

  config["proxy-providers"] ??= {};
  config["proxy-groups"] ??= [];
  config.rules ??= [];

  // ========== 1) è®¢é˜…æº ==========
  config["proxy-providers"]["SubA"] = {
    type: "http",
    url: SUB_A_URL,
    interval: 86400,
    "health-check": {
      enable: true,
      url: "https://www.gstatic.com/generate_204",
      interval: 300,
    },
    override: { "additional-suffix": " @A" },
  };

  config["proxy-providers"]["SubB"] = {
    type: "http",
    url: SUB_B_URL,
    interval: 86400,
    "health-check": {
      enable: true,
      url: "https://www.gstatic.com/generate_204",
      interval: 300,
    },
    override: { "additional-suffix": " @B" },
  };

  config["proxy-providers"]["SubC"] = {
    type: "http",
    url: SUB_C_URL,
    interval: 86400,
    "health-check": {
      enable: true,
      url: "https://www.gstatic.com/generate_204",
      interval: 300,
    },
    override: { "additional-suffix": " @C" },
  };

  // ========== 2) è§„åˆ™æä¾›è€…ï¼ˆGEOSITE è§„åˆ™é›†ï¼‰ ==========
  config["rule-providers"] ??= {};

  // Google å…¨å®¶æ¡¶è§„åˆ™é›†
  config["rule-providers"]["geosite-google"] = {
    type: "http",
    behavior: "domain",
    url: "https://cdn.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@meta/geo/geosite/google.yaml",
    path: "./ruleset/geosite-google.yaml",
    interval: 86400,
  };

  // YouTube è§„åˆ™é›†
  config["rule-providers"]["geosite-youtube"] = {
    type: "http",
    behavior: "domain",
    url: "https://cdn.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@meta/geo/geosite/youtube.yaml",
    path: "./ruleset/geosite-youtube.yaml",
    interval: 86400,
  };

  // GFW è§„åˆ™é›†ï¼ˆå·²çŸ¥è¢«å¢™åŸŸåï¼Œå…œåº•èµ°ä»£ç†ï¼‰
  config["rule-providers"]["geosite-gfw"] = {
    type: "http",
    behavior: "domain",
    url: "https://cdn.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@meta/geo/geosite/gfw.yaml",
    path: "./ruleset/geosite-gfw.yaml",
    interval: 86400,
  };

  // å›½å†…åŸŸåè§„åˆ™é›†ï¼ˆç›´è¿åŠ é€Ÿåˆ¤æ–­ï¼‰
  config["rule-providers"]["geosite-cn"] = {
    type: "http",
    behavior: "domain",
    url: "https://cdn.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@meta/geo/geosite/cn.yaml",
    path: "./ruleset/geosite-cn.yaml",
    interval: 86400,
  };

  // ç§æœ‰/å±€åŸŸç½‘ IP è§„åˆ™é›†
  config["rule-providers"]["geoip-private"] = {
    type: "http",
    behavior: "ipcidr",
    url: "https://cdn.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@meta/geo/geoip/private.yaml",
    path: "./ruleset/geoip-private.yaml",
    interval: 86400,
  };

  // ========== 3) ä»£ç†ç»„ ==========
  const groups = config["proxy-groups"];

  // ğŸ‡ºğŸ‡¸ A+B ç¾å›½èŠ‚ç‚¹è‡ªåŠ¨é€‰æœ€å¿«
  upsertGroup(groups, {
    name: "ğŸ‡ºğŸ‡¸US-Auto",
    type: "url-test",
    use: ["SubA", "SubB"],
    filter: US_FILTER,
    url: "https://www.gstatic.com/generate_204",
    interval: 300,
    tolerance: 50,
  });

  // C è®¢é˜…è‡ªåŠ¨é€‰æœ€å¿«ï¼ˆå…¶ä»–å¢ƒå¤–æµé‡ï¼‰
  upsertGroup(groups, {
    name: "ğŸŒC-Auto",
    type: "url-test",
    use: ["SubC"],
    url: "https://www.gstatic.com/generate_204",
    interval: 300,
    tolerance: 50,
  });

  // Google ä¸“å±ç»„ï¼šUS-Auto ä¸å¯ç”¨ â†’ ç›´æ¥ REJECT é˜»æ–­
  // fallback æœºåˆ¶ï¼šå¥åº·æ£€æŸ¥å¤±è´¥è‡ªåŠ¨é™çº§åˆ°ä¸‹ä¸€ä¸ª
  upsertGroup(groups, {
    name: "ğŸ”Google",
    type: "fallback",
    proxies: ["ğŸ‡ºğŸ‡¸US-Auto", "REJECT"],
    url: "https://www.gstatic.com/generate_204",
    interval: 300,
  });

  // æ€»å‡ºå£é€‰æ‹©ç»„ï¼ˆæ‰‹åŠ¨åˆ‡æ¢ / å¯è§†åŒ–ç”¨ï¼‰
  upsertGroup(groups, {
    name: "ğŸš€Proxy",
    type: "select",
    proxies: ["ğŸŒC-Auto", "ğŸ‡ºğŸ‡¸US-Auto", "DIRECT"],
  });

  // ========== 4) è§„åˆ™åˆ—è¡¨ï¼ˆå®Œå…¨é‡å»ºï¼Œé¡ºåºå³ä¼˜å…ˆçº§ï¼‰ ==========
  setRules(config, [
    // ---- ç¬¬ä¸€å±‚ï¼šå±€åŸŸç½‘ / ç§æœ‰åœ°å€ ç›´è¿ ----
    "RULE-SET,geoip-private,DIRECT,no-resolve",

    // ---- ç¬¬äºŒå±‚ï¼šå›½å†…åŸŸå ç›´è¿ï¼ˆåŸŸååˆ¤æ–­ï¼Œé€Ÿåº¦å¿«ï¼‰ ----
    "RULE-SET,geosite-cn,DIRECT",

    // ---- ç¬¬ä¸‰å±‚ï¼šGoogle/YouTube èµ°ç¾å›½ä¸“å±ç»„ ----
    "RULE-SET,geosite-google,ğŸ”Google",
    "RULE-SET,geosite-youtube,ğŸ”Google",

    // ---- ç¬¬ä¸‰å±‚è¡¥å……ï¼šDOMAIN-SUFFIX å…œåº•ï¼ˆé˜²è§„åˆ™é›†æœªè¦†ç›–ï¼‰ ----
    "DOMAIN-SUFFIX,google.com,ğŸ”Google",
    "DOMAIN-SUFFIX,google.com.hk,ğŸ”Google",
    "DOMAIN-SUFFIX,googleapis.com,ğŸ”Google",
    "DOMAIN-SUFFIX,gstatic.com,ğŸ”Google",
    "DOMAIN-SUFFIX,googleusercontent.com,ğŸ”Google",
    "DOMAIN-SUFFIX,ggpht.com,ğŸ”Google",
    "DOMAIN-SUFFIX,1e100.net,ğŸ”Google",
    "DOMAIN-SUFFIX,youtube.com,ğŸ”Google",
    "DOMAIN-SUFFIX,googlevideo.com,ğŸ”Google",
    "DOMAIN-SUFFIX,ytimg.com,ğŸ”Google",
    "DOMAIN-SUFFIX,youtube-nocookie.com,ğŸ”Google",
    "DOMAIN-SUFFIX,google-analytics.com,ğŸ”Google",
    "DOMAIN-SUFFIX,googletagmanager.com,ğŸ”Google",
    "DOMAIN-SUFFIX,googlesyndication.com,ğŸ”Google",
    "DOMAIN-SUFFIX,googleadservices.com,ğŸ”Google",
    "DOMAIN-SUFFIX,gmail.com,ğŸ”Google",
    "DOMAIN-SUFFIX,googlesource.com,ğŸ”Google",

    // ---- ç¬¬å››å±‚ï¼šå·²çŸ¥ GFW å°é”åŸŸå â†’ èµ°ä»£ç†å‡ºå£ ----
    "RULE-SET,geosite-gfw,ğŸš€Proxy",

    // ---- ç¬¬äº”å±‚ï¼šGEOIP ä¸­å›½ IP ç›´è¿ï¼ˆå…œåº• IP åˆ¤æ–­ï¼‰ ----
    "GEOIP,CN,DIRECT,no-resolve",

    // ---- ç¬¬å…­å±‚ï¼šå…œåº• ----
    // æ—¢ä¸æ˜¯å›½å†…ã€ä¹Ÿä¸æ˜¯ Google â†’ å…¶ä»–å¢ƒå¤–æµé‡èµ° C-Auto
    "MATCH,ğŸš€Proxy",
  ]);

  return config;
};