name: Auto Update & Deploy

on:
  # å®šæ—¶æ£€æŸ¥æ›´æ–°ï¼ˆæ¯å¤© UTC 0:00ï¼‰
  schedule:
    - cron: '0 0 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # ä»£ç æ¨é€æ—¶è§¦å‘
  push:
    branches: [master, main]
    paths:
      - '.github/workflows/auto-update.yml'
      - 'Dockerfile'
      - 'docker-compose.yml'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  # ä¸‰ä¸ªæœåŠ¡çš„å®˜æ–¹é•œåƒç‰ˆæœ¬
  SUB_STORE_VERSION: 'latest'
  MIHOMO_VERSION: 'latest'
  METACUBEXD_VERSION: 'latest'

jobs:
  check-updates:
    name: æ£€æŸ¥æ›´æ–°
    runs-on: ubuntu-latest
    outputs:
      sub-store-update: ${{ steps.check-sub-store.outputs.update }}
      mihomo-update: ${{ steps.check-mihomo.outputs.update }}
      metacubexd-update: ${{ steps.check-metacubexd.outputs.update }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. æ£€æŸ¥ Sub-Store æ›´æ–°
      - name: æ£€æŸ¥ Sub-Store (sub-web) æ›´æ–°
        id: check-sub-store
        run: |
          CURRENT_VERSION=$(grep -oP "SUB_STORE_VERSION:\\s*'\\K[^']+" .github/workflows/auto-update.yml || echo "unknown")
          LATEST_VERSION=$(curl -s https://api.github.com/repos/CareyWang/sub-web/releases/latest | grep -oP '"tag_name":\s*"\K[^"]+' || echo "unknown")
          
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
          echo "æœ€æ–°ç‰ˆæœ¬: $LATEST_VERSION"
          
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ] && [ "$LATEST_VERSION" != "unknown" ]; then
            echo "update=true" >> $GITHUB_OUTPUT
          else
            echo "update=false" >> $GITHUB_OUTPUT
          fi

      # 2. æ£€æŸ¥ Mihomo æ›´æ–°
      - name: æ£€æŸ¥ Mihomo æ›´æ–°
        id: check-mihomo
        run: |
          CURRENT_VERSION=$(grep -oP "MIHOMO_VERSION:\\s*'\\K[^']+" .github/workflows/auto-update.yml || echo "unknown")
          LATEST_VERSION=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | grep -oP '"tag_name":\s*"\K[^"]+' || echo "unknown")
          
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
          echo "æœ€æ–°ç‰ˆæœ¬: $LATEST_VERSION"
          
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ] && [ "$LATEST_VERSION" != "unknown" ]; then
            echo "update=true" >> $GITHUB_OUTPUT
          else
            echo "update=false" >> $GITHUB_OUTPUT
          fi

      # 3. æ£€æŸ¥ Metacubexd æ›´æ–°
      - name: æ£€æŸ¥ Metacubexd æ›´æ–°
        id: check-metacubexd
        run: |
          CURRENT_VERSION=$(grep -oP "METACUBEXD_VERSION:\\s*'\\K[^']+" .github/workflows/auto-update.yml || echo "unknown")
          LATEST_VERSION=$(curl -s https://api.github.com/repos/MetaCubeX/metacubexd/releases/latest | grep -oP '"tag_name":\s*"\K[^"]+' || echo "unknown")
          
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
          echo "æœ€æ–°ç‰ˆæœ¬: $LATEST_VERSION"
          
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ] && [ "$LATEST_VERSION" != "unknown" ]; then
            echo "update=true" >> $GITHUB_OUTPUT
          else
            echo "update=false" >> $GITHUB_OUTPUT
          fi

  build-and-push:
    name: æ„å»ºå¹¶æ¨é€é•œåƒ
    needs: check-updates
    if: needs.check-updates.outputs.sub-store-update == 'true' || 
        needs.check-updates.outputs.mihomo-update == 'true' ||
        needs.check-updates.outputs.metacubexd-update == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ github.run_id }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Update version numbers
        run: |
          # è·å–æœ€æ–°ç‰ˆæœ¬å·
          SUB_STORE_LATEST=$(curl -s https://api.github.com/repos/CareyWang/sub-web/releases/latest | grep -oP '"tag_name":\s*"\K[^"]+')
          MIHOMO_LATEST=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | grep -oP '"tag_name":\s*"\K[^"]+')
          METACUBEXD_LATEST=$(curl -s https://api.github.com/repos/MetaCubeX/metacubexd/releases/latest | grep -oP '"tag_name":\s*"\K[^"]+')
          
          # æ›´æ–° workflow æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬å·
          sed -i "s/SUB_STORE_VERSION: '.*'/SUB_STORE_VERSION: '$SUB_STORE_LATEST'/g" .github/workflows/auto-update.yml
          sed -i "s/MIHOMO_VERSION: '.*'/MIHOMO_VERSION: '$MIHOMO_LATEST'/g" .github/workflows/auto-update.yml
          sed -i "s/METACUBEXD_VERSION: '.*'/METACUBEXD_VERSION: '$METACUBEXD_LATEST'/g" .github/workflows/auto-update.yml
          
          # æäº¤æ›´æ–°
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "chore: æ›´æ–°ç‰ˆæœ¬å·åˆ° ${SUB_STORE_LATEST}, ${MIHOMO_LATEST}, ${METACUBEXD_LATEST}" || echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          git push || echo "æ¨é€å¤±è´¥ï¼ˆå¯èƒ½æ²¡æœ‰å˜æ›´ï¼‰"

      - name: Create Release
        if: github.ref_name == github.event.repository.default_branch
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_id }}
          release_name: Release v${{ github.run_id }}
          body: |
            ## æ›´æ–°å†…å®¹
            
            - ğŸ†• Sub-Store: æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
            - âš¡ Mihomo: æ€§èƒ½ä¼˜åŒ–
            - ğŸ¨ Metacubexd: UI æ”¹è¿›
          draft: false
          prerelease: false

  deploy:
    name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref_name == github.event.repository.default_branch
    environment:
      name: production
      url: https://github.com/${{ github.repository }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd ${{ secrets.SERVER_DEPLOY_PATH }}
            docker-compose pull
            docker-compose up -d
            echo "éƒ¨ç½²å®Œæˆ"
