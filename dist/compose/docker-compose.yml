services:
  clash:
    image: ${IMAGE_REF:-ghcr.io/lim12137/clash2web:latest}
    container_name: clash-meta-manager
    restart: unless-stopped
    ports:
      - "${WEB_PORT:-80}:80"
      - "${MIXED_PORT:-17890}:17890"
      - "${SOCKS_PORT:-7891}:7891"
    environment:
      TZ: ${TZ:-Asia/Shanghai}
      CLASH_SECRET: ${CLASH_SECRET:-}
      ADMIN_TOKEN: ${ADMIN_TOKEN:-}
      API_PORT: ${API_PORT:-19092}
      PYTHON_BIN: /usr/bin/python3
      MIHOMO_CORE_DIR: /opt/mihomo-core
      MIHOMO_BIN: /opt/mihomo-core/mihomo
      CORE_UPDATE_ALLOWED_REPOS: ${CORE_UPDATE_ALLOWED_REPOS:-MetaCubeX/mihomo}
      CORE_UPDATE_REQUIRE_CHECKSUM: ${CORE_UPDATE_REQUIRE_CHECKSUM:-1}
    cap_add:
      - NET_ADMIN
    volumes:
      - config_data:/root/.config/mihomo
      - scripts_data:/scripts
      - core_data:/opt/mihomo-core
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://127.0.0.1/api/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5

volumes:
  config_data:
  scripts_data:
  core_data:
