

# å¯è§†åŒ–è„šæœ¬ç®¡ç†æ–¹æ¡ˆ

åœ¨æ–¹æ¡ˆä¸€åŸºç¡€ä¸Šï¼Œå¢åŠ ä¸€ä¸ª **Web ç®¡ç†é¢æ¿**ï¼Œå¯ä»¥åœ¨æµè§ˆå™¨ä¸­å¯è§†åŒ–ç®¡ç†è®¢é˜…ã€ç¼–è¾‘è¦†ç›–è§„åˆ™ã€å®æ—¶æŸ¥çœ‹æ—¥å¿—ç­‰ã€‚

---

## æ¶æ„å‡çº§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Docker Container                    â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ mihomo     â”‚  â”‚ metacubexd   â”‚  â”‚ ç®¡ç†é¢æ¿API   â”‚ â”‚
â”‚  â”‚ :7890/7891 â”‚  â”‚ :9091        â”‚  â”‚ (Flask)      â”‚ â”‚
â”‚  â”‚ API :9090  â”‚  â”‚ (èŠ‚ç‚¹åˆ‡æ¢)    â”‚  â”‚ :9092        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚        â”‚                                   â”‚         â”‚
â”‚        â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚         â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  config.yaml â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              Nginx åå‘ä»£ç†                    â”‚    â”‚
â”‚  â”‚  /          â†’ ç®¡ç†é¢æ¿å‰ç«¯                     â”‚    â”‚
â”‚  â”‚  /api/      â†’ Flask API (:9092)              â”‚    â”‚
â”‚  â”‚  /clash-ui/ â†’ metacubexd (:9091 é™æ€æ–‡ä»¶)     â”‚    â”‚
â”‚  â”‚  /clash-api/â†’ mihomo API (:9090)             â”‚    â”‚
â”‚  â”‚  ç«¯å£: 80                                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®Œæ•´é¡¹ç›®ç»“æ„

```
clash-docker/
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ nginx.conf
â”œâ”€â”€ entrypoint.sh
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ config.yaml
â”‚   â””â”€â”€ subs/
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ subscriptions.json
â”‚   â”œâ”€â”€ override.yaml
â”‚   â”œâ”€â”€ template.yaml
â”‚   â”œâ”€â”€ merge.py              # åˆå¹¶è„šæœ¬ï¼ˆä¸Šä¸€ç‰ˆï¼‰
â”‚   â””â”€â”€ api_server.py         # Web API æœåŠ¡
â”œâ”€â”€ web/                      # ç®¡ç†é¢æ¿å‰ç«¯
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ style.css
â”‚   â””â”€â”€ app.js
â””â”€â”€ ui/                       # metacubexd (è‡ªåŠ¨ä¸‹è½½)
```

---

## 1. Docker Compose

```yaml
# docker-compose.yml
version: '3.8'

services:
  clash:
    build: .
    container_name: clash-meta
    restart: unless-stopped
    ports:
      - "7890:7890"      # HTTP ä»£ç†
      - "7891:7891"      # SOCKS5 ä»£ç†
      - "9090:9090"      # Clash API
      - "80:80"          # ç®¡ç†é¢æ¿ + Clash UI
    volumes:
      - ./config:/root/.config/mihomo
      - ./scripts:/scripts
      - ./web:/web
    environment:
      - TZ=Asia/Shanghai
      - CLASH_SECRET=your_secret_here
    cap_add:
      - NET_ADMIN
```

## 2. Dockerfile

```dockerfile
FROM alpine:3.19

RUN apk add --no-cache \
    curl jq bash nginx dcron tzdata \
    python3 py3-pip py3-yaml py3-requests \
    ca-certificates

# Python ä¾èµ–
RUN pip3 install --break-system-packages flask flask-cors

# ä¸‹è½½ mihomo
ARG TARGETARCH=amd64
RUN LATEST=$(curl -sL https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | jq -r '.tag_name') && \
    ARCH=$(case "${TARGETARCH}" in "arm64") echo "arm64";; *) echo "amd64";; esac) && \
    curl -Lo /tmp/mihomo.gz \
      "https://github.com/MetaCubeX/mihomo/releases/download/${LATEST}/mihomo-linux-${ARCH}-${LATEST}.gz" && \
    gunzip /tmp/mihomo.gz && mv /tmp/mihomo /usr/local/bin/mihomo && chmod +x /usr/local/bin/mihomo

# ä¸‹è½½ metacubexd
RUN LATEST_UI=$(curl -sL https://api.github.com/repos/MetaCubeX/metacubexd/releases/latest | jq -r '.tag_name') && \
    curl -Lo /tmp/ui.tgz \
      "https://github.com/MetaCubeX/metacubexd/releases/download/${LATEST_UI}/compressed-dist.tgz" && \
    mkdir -p /clash-ui && tar -xzf /tmp/ui.tgz -C /clash-ui && rm /tmp/ui.tgz

COPY nginx.conf /etc/nginx/http.d/default.conf
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

RUN mkdir -p /root/.config/mihomo/subs /root/.config/mihomo/backups /root/.config/mihomo/ruleset

EXPOSE 7890 7891 9090 80

ENTRYPOINT ["/entrypoint.sh"]
```

## 3. Nginx é…ç½®

```nginx
# nginx.conf
server {
    listen 80;
    server_name _;

    # ç®¡ç†é¢æ¿å‰ç«¯
    location / {
        root /web;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # ç®¡ç†é¢æ¿ API
    location /api/ {
        proxy_pass http://127.0.0.1:9092/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_read_timeout 120s;
    }

    # SSE æ—¥å¿—æµ
    location /api/logs/stream {
        proxy_pass http://127.0.0.1:9092/api/logs/stream;
        proxy_set_header Connection '';
        proxy_http_version 1.1;
        chunked_transfer_encoding off;
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400s;
    }

    # metacubexd (Clash èŠ‚ç‚¹åˆ‡æ¢ UI)
    location /clash-ui/ {
        alias /clash-ui/;
        index index.html;
        try_files $uri $uri/ /clash-ui/index.html;
    }

    # Clash API ä»£ç† (ç»™å‰ç«¯ WebSocket ç”¨)
    location /clash-api/ {
        proxy_pass http://127.0.0.1:9090/;
        proxy_set_header Host $host;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

## 4. å¯åŠ¨è„šæœ¬

```bash
#!/bin/bash
# entrypoint.sh
set -e

echo "=== Clash Meta + Visual Manager ==="

# åˆå§‹åŒ–
[ ! -f /scripts/subscriptions.json ] && echo '{"subscriptions":[]}' > /scripts/subscriptions.json
[ ! -f /root/.config/mihomo/config.yaml ] && cp /scripts/template.yaml /root/.config/mihomo/config.yaml

# é¦–æ¬¡åˆå¹¶
python3 /scripts/merge.py 2>&1 || true

# å¯åŠ¨ nginx
nginx

# å¯åŠ¨ç®¡ç† API
python3 /scripts/api_server.py &
echo "[OK] Management API started on :9092"

# å¯åŠ¨ mihomo
echo "[OK] Starting mihomo..."
exec mihomo -d /root/.config/mihomo
```

---

## 5. Web API æœåŠ¡ (æ ¸å¿ƒåç«¯)

```python
#!/usr/bin/env python3
"""
scripts/api_server.py
å¯è§†åŒ–ç®¡ç†é¢æ¿ API åç«¯
"""

import json
import os
import re
import sys
import time
import shutil
import threading
import subprocess
import queue
from pathlib import Path
from datetime import datetime
from functools import wraps

import yaml
import requests
from flask import Flask, request, jsonify, Response, stream_with_context
from flask_cors import CORS

# ========== è·¯å¾„ ==========
BASE_DIR = Path("/root/.config/mihomo")
SCRIPTS_DIR = Path("/scripts")
SUBS_DIR = BASE_DIR / "subs"
BACKUP_DIR = BASE_DIR / "backups"
CONFIG_FILE = BASE_DIR / "config.yaml"
SUBS_CONFIG = SCRIPTS_DIR / "subscriptions.json"
OVERRIDE_FILE = SCRIPTS_DIR / "override.yaml"
TEMPLATE_FILE = SCRIPTS_DIR / "template.yaml"

CLASH_API = "http://127.0.0.1:9090"
CLASH_SECRET = os.environ.get("CLASH_SECRET", "")

# ========== App ==========
app = Flask(__name__)
CORS(app)

# æ—¥å¿—é˜Ÿåˆ— (SSE)
log_queues = []
log_history = []
MAX_LOG_HISTORY = 500

# æ“ä½œé”
merge_lock = threading.Lock()


def emit_log(msg, level="INFO"):
    """å‘é€æ—¥å¿—åˆ°æ‰€æœ‰ SSE å®¢æˆ·ç«¯"""
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    entry = {"time": timestamp, "level": level, "msg": msg}
    log_history.append(entry)
    if len(log_history) > MAX_LOG_HISTORY:
        log_history.pop(0)
    for q in log_queues:
        try:
            q.put_nowait(entry)
        except:
            pass
    print(f"[{timestamp}] [{level}] {msg}", flush=True)


def load_json(path):
    try:
        with open(path, 'r', encoding='utf-8') as f:
            return json.load(f)
    except:
        return {}


def save_json(data, path):
    with open(path, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=2)


def load_yaml_file(path):
    try:
        with open(path, 'r', encoding='utf-8') as f:
            return yaml.safe_load(f) or {}
    except:
        return {}


def save_yaml_file(data, path):
    with open(path, 'w', encoding='utf-8') as f:
        yaml.dump(data, f, default_flow_style=False, allow_unicode=True, sort_keys=False)


def read_text(path):
    try:
        with open(path, 'r', encoding='utf-8') as f:
            return f.read()
    except:
        return ""


def write_text(content, path):
    with open(path, 'w', encoding='utf-8') as f:
        f.write(content)


def reload_clash():
    """é€šçŸ¥ clash é‡è½½"""
    try:
        headers = {"Authorization": f"Bearer {CLASH_SECRET}"} if CLASH_SECRET else {}
        resp = requests.put(f"{CLASH_API}/configs",
                            json={"path": str(CONFIG_FILE)},
                            headers=headers, timeout=5)
        return resp.status_code == 204
    except:
        return False


# ==========================================
#  API: è®¢é˜…ç®¡ç†
# ==========================================

@app.route('/api/subscriptions', methods=['GET'])
def get_subscriptions():
    """è·å–æ‰€æœ‰è®¢é˜…"""
    data = load_json(SUBS_CONFIG)
    subs = data.get("subscriptions", [])

    # é™„åŠ ç¼“å­˜ä¿¡æ¯
    for sub in subs:
        cached = SUBS_DIR / f"{sub['name']}.yaml"
        if cached.exists():
            sub["cached"] = True
            sub["cached_time"] = datetime.fromtimestamp(
                cached.stat().st_mtime
            ).strftime("%Y-%m-%d %H:%M:%S")
            cached_data = load_yaml_file(cached)
            sub["node_count"] = len(cached_data.get("proxies", []))
        else:
            sub["cached"] = False
            sub["node_count"] = 0

    return jsonify({"success": True, "data": subs})


@app.route('/api/subscriptions', methods=['POST'])
def add_subscription():
    """æ·»åŠ è®¢é˜…"""
    body = request.json
    name = body.get("name", "").strip()
    url = body.get("url", "").strip()

    if not name or not url:
        return jsonify({"success": False, "error": "Name and URL are required"}), 400

    data = load_json(SUBS_CONFIG)
    if not data.get("subscriptions"):
        data["subscriptions"] = []

    # æ£€æŸ¥é‡å
    existing = [s for s in data["subscriptions"] if s["name"] == name]
    if existing:
        return jsonify({"success": False, "error": f"Subscription '{name}' already exists"}), 409

    new_sub = {
        "name": name,
        "url": url,
        "enabled": body.get("enabled", True),
        "prefix": body.get("prefix", f"{name[:2]}_"),
        "exclude_filter": body.get("exclude_filter", "(?i)(è¿‡æœŸ|å‰©ä½™|å®˜ç½‘|æµé‡)"),
        "include_filter": body.get("include_filter", ""),
        "emoji": body.get("emoji", True)
    }
    data["subscriptions"].append(new_sub)
    save_json(data, SUBS_CONFIG)

    emit_log(f"Subscription added: {name}")
    return jsonify({"success": True, "data": new_sub})


@app.route('/api/subscriptions/<name>', methods=['PUT'])
def update_subscription(name):
    """æ›´æ–°è®¢é˜…"""
    body = request.json
    data = load_json(SUBS_CONFIG)

    found = False
    for sub in data.get("subscriptions", []):
        if sub["name"] == name:
            for key in ["url", "enabled", "prefix", "exclude_filter", "include_filter", "emoji"]:
                if key in body:
                    sub[key] = body[key]
            # æ”¯æŒé‡å‘½å
            if "new_name" in body and body["new_name"] != name:
                old_cache = SUBS_DIR / f"{name}.yaml"
                sub["name"] = body["new_name"]
                if old_cache.exists():
                    old_cache.rename(SUBS_DIR / f"{body['new_name']}.yaml")
            found = True
            break

    if not found:
        return jsonify({"success": False, "error": "Not found"}), 404

    save_json(data, SUBS_CONFIG)
    emit_log(f"Subscription updated: {name}")
    return jsonify({"success": True})


@app.route('/api/subscriptions/<name>', methods=['DELETE'])
def delete_subscription(name):
    """åˆ é™¤è®¢é˜…"""
    data = load_json(SUBS_CONFIG)
    data["subscriptions"] = [s for s in data.get("subscriptions", []) if s["name"] != name]
    save_json(data, SUBS_CONFIG)

    cached = SUBS_DIR / f"{name}.yaml"
    if cached.exists():
        cached.unlink()

    emit_log(f"Subscription removed: {name}")
    return jsonify({"success": True})


@app.route('/api/subscriptions/<name>/toggle', methods=['POST'])
def toggle_subscription(name):
    """å¯ç”¨/ç¦ç”¨"""
    data = load_json(SUBS_CONFIG)
    for sub in data.get("subscriptions", []):
        if sub["name"] == name:
            sub["enabled"] = not sub.get("enabled", True)
            save_json(data, SUBS_CONFIG)
            status = "enabled" if sub["enabled"] else "disabled"
            emit_log(f"Subscription {status}: {name}")
            return jsonify({"success": True, "enabled": sub["enabled"]})

    return jsonify({"success": False, "error": "Not found"}), 404


@app.route('/api/subscriptions/<name>/test', methods=['POST'])
def test_subscription(name):
    """æµ‹è¯•æ‹‰å–è®¢é˜…"""
    data = load_json(SUBS_CONFIG)
    sub = next((s for s in data.get("subscriptions", []) if s["name"] == name), None)

    if not sub:
        return jsonify({"success": False, "error": "Not found"}), 404

    try:
        resp = requests.get(sub["url"],
                            headers={"User-Agent": "clash.meta"},
                            timeout=15)
        resp.raise_for_status()
        content = yaml.safe_load(resp.text)

        if not content:
            return jsonify({"success": False, "error": "Empty response"})

        proxies = content.get("proxies", [])
        return jsonify({
            "success": True,
            "node_count": len(proxies),
            "sample_nodes": [p.get("name", "?") for p in proxies[:10]],
            "response_size": len(resp.text)
        })
    except Exception as e:
        return jsonify({"success": False, "error": str(e)})


@app.route('/api/subscriptions/<name>/nodes', methods=['GET'])
def get_subscription_nodes(name):
    """æŸ¥çœ‹è®¢é˜…ç¼“å­˜çš„èŠ‚ç‚¹åˆ—è¡¨"""
    cached = SUBS_DIR / f"{name}.yaml"
    if not cached.exists():
        return jsonify({"success": False, "error": "No cached data"}), 404

    data = load_yaml_file(cached)
    proxies = data.get("proxies", [])
    nodes = []
    for p in proxies:
        nodes.append({
            "name": p.get("name", ""),
            "type": p.get("type", ""),
            "server": p.get("server", ""),
            "port": p.get("port", "")
        })

    return jsonify({"success": True, "data": nodes, "total": len(nodes)})


# ==========================================
#  API: è¦†ç›–/è„šæœ¬ç¼–è¾‘
# ==========================================

@app.route('/api/override', methods=['GET'])
def get_override():
    """è·å–è¦†ç›–è§„åˆ™ (åŸå§‹YAMLæ–‡æœ¬)"""
    content = read_text(OVERRIDE_FILE)
    return jsonify({"success": True, "content": content})


@app.route('/api/override', methods=['PUT'])
def save_override():
    """ä¿å­˜è¦†ç›–è§„åˆ™"""
    body = request.json
    content = body.get("content", "")

    # éªŒè¯ YAML è¯­æ³•
    try:
        yaml.safe_load(content)
    except yaml.YAMLError as e:
        return jsonify({"success": False, "error": f"YAML syntax error: {e}"}), 400

    # å¤‡ä»½
    if OVERRIDE_FILE.exists():
        backup = SCRIPTS_DIR / f"override.yaml.bak.{int(time.time())}"
        shutil.copy2(OVERRIDE_FILE, backup)

    write_text(content, OVERRIDE_FILE)
    emit_log("Override config updated")
    return jsonify({"success": True})


@app.route('/api/override/validate', methods=['POST'])
def validate_override():
    """éªŒè¯è¦†ç›–è§„åˆ™ YAML"""
    body = request.json
    content = body.get("content", "")
    try:
        parsed = yaml.safe_load(content)
        return jsonify({
            "success": True,
            "valid": True,
            "keys": list(parsed.keys()) if parsed else []
        })
    except yaml.YAMLError as e:
        return jsonify({"success": True, "valid": False, "error": str(e)})


@app.route('/api/template', methods=['GET'])
def get_template():
    """è·å–åŸºç¡€æ¨¡æ¿"""
    content = read_text(TEMPLATE_FILE)
    return jsonify({"success": True, "content": content})


@app.route('/api/template', methods=['PUT'])
def save_template():
    """ä¿å­˜åŸºç¡€æ¨¡æ¿"""
    body = request.json
    content = body.get("content", "")
    try:
        yaml.safe_load(content)
    except yaml.YAMLError as e:
        return jsonify({"success": False, "error": f"YAML error: {e}"}), 400

    write_text(content, TEMPLATE_FILE)
    emit_log("Template config updated")
    return jsonify({"success": True})


@app.route('/api/merge-script', methods=['GET'])
def get_merge_script():
    """è·å–åˆå¹¶è„šæœ¬å†…å®¹"""
    content = read_text(SCRIPTS_DIR / "merge.py")
    return jsonify({"success": True, "content": content})


@app.route('/api/merge-script', methods=['PUT'])
def save_merge_script():
    """ä¿å­˜åˆå¹¶è„šæœ¬"""
    body = request.json
    content = body.get("content", "")

    # åŸºæœ¬çš„ Python è¯­æ³•æ£€æŸ¥
    try:
        compile(content, "merge.py", "exec")
    except SyntaxError as e:
        return jsonify({"success": False, "error": f"Python syntax error: {e}"}), 400

    backup = SCRIPTS_DIR / f"merge.py.bak.{int(time.time())}"
    shutil.copy2(SCRIPTS_DIR / "merge.py", backup)

    write_text(content, SCRIPTS_DIR / "merge.py")
    emit_log("Merge script updated")
    return jsonify({"success": True})


# ==========================================
#  API: å½“å‰é…ç½®æŸ¥çœ‹
# ==========================================

@app.route('/api/config', methods=['GET'])
def get_config():
    """è·å–å½“å‰ç”Ÿæ•ˆçš„ config.yaml"""
    content = read_text(CONFIG_FILE)
    return jsonify({"success": True, "content": content})


@app.route('/api/config/summary', methods=['GET'])
def get_config_summary():
    """è·å–é…ç½®æ‘˜è¦"""
    config = load_yaml_file(CONFIG_FILE)
    proxies = config.get("proxies", [])
    groups = config.get("proxy-groups", [])
    rules = config.get("rules", [])

    # ç»Ÿè®¡èŠ‚ç‚¹ç±»å‹
    type_stats = {}
    for p in proxies:
        t = p.get("type", "unknown")
        type_stats[t] = type_stats.get(t, 0) + 1

    return jsonify({
        "success": True,
        "data": {
            "proxy_count": len(proxies),
            "group_count": len(groups),
            "rule_count": len(rules),
            "proxy_types": type_stats,
            "groups": [{"name": g.get("name"), "type": g.get("type"),
                        "count": len(g.get("proxies", []) + g.get("use", []))}
                       for g in groups],
            "mode": config.get("mode", "unknown"),
            "port": config.get("mixed-port", "unknown")
        }
    })


# ==========================================
#  API: æ“ä½œï¼ˆåˆå¹¶ã€é‡è½½ã€å¤‡ä»½ï¼‰
# ==========================================

@app.route('/api/actions/merge', methods=['POST'])
def do_merge():
    """æ‰§è¡Œåˆå¹¶"""
    if not merge_lock.acquire(blocking=False):
        return jsonify({"success": False, "error": "Merge already in progress"}), 429

    def run_merge():
        try:
            emit_log("Starting merge process...")
            result = subprocess.run(
                ["python3", str(SCRIPTS_DIR / "merge.py"), "merge"],
                capture_output=True, text=True, timeout=120
            )
            for line in result.stdout.strip().split('\n'):
                if line.strip():
                    emit_log(line.strip())
            if result.returncode != 0:
                for line in result.stderr.strip().split('\n'):
                    if line.strip():
                        emit_log(line.strip(), "ERROR")
                emit_log("Merge failed!", "ERROR")
            else:
                emit_log("Merge completed successfully", "SUCCESS")
        except subprocess.TimeoutExpired:
            emit_log("Merge timed out!", "ERROR")
        except Exception as e:
            emit_log(f"Merge error: {e}", "ERROR")
        finally:
            merge_lock.release()

    thread = threading.Thread(target=run_merge, daemon=True)
    thread.start()

    return jsonify({"success": True, "message": "Merge started"})


@app.route('/api/actions/reload', methods=['POST'])
def do_reload():
    """é‡è½½ Clash é…ç½®"""
    success = reload_clash()
    if success:
        emit_log("Clash config reloaded")
    else:
        emit_log("Failed to reload Clash config", "ERROR")
    return jsonify({"success": success})


@app.route('/api/actions/test-config', methods=['POST'])
def do_test_config():
    """æµ‹è¯•é…ç½®æœ‰æ•ˆæ€§"""
    try:
        result = subprocess.run(
            ["mihomo", "-t", "-d", str(BASE_DIR)],
            capture_output=True, text=True, timeout=10
        )
        valid = result.returncode == 0
        return jsonify({
            "success": True,
            "valid": valid,
            "output": result.stdout + result.stderr
        })
    except Exception as e:
        return jsonify({"success": False, "error": str(e)})


# ==========================================
#  API: å¤‡ä»½ç®¡ç†
# ==========================================

@app.route('/api/backups', methods=['GET'])
def list_backups():
    """åˆ—å‡ºæ‰€æœ‰å¤‡ä»½"""
    BACKUP_DIR.mkdir(exist_ok=True)
    backups = []
    for f in sorted(BACKUP_DIR.glob("*.yaml"), reverse=True):
        backups.append({
            "name": f.name,
            "size": f.stat().st_size,
            "time": datetime.fromtimestamp(f.stat().st_mtime).strftime("%Y-%m-%d %H:%M:%S")
        })
    return jsonify({"success": True, "data": backups})


@app.route('/api/backups', methods=['POST'])
def create_backup():
    """æ‰‹åŠ¨åˆ›å»ºå¤‡ä»½"""
    BACKUP_DIR.mkdir(exist_ok=True)
    name = f"manual_{datetime.now().strftime('%Y%m%d_%H%M%S')}.yaml"
    shutil.copy2(CONFIG_FILE, BACKUP_DIR / name)
    emit_log(f"Backup created: {name}")
    return jsonify({"success": True, "name": name})


@app.route('/api/backups/<name>/restore', methods=['POST'])
def restore_backup(name):
    """æ¢å¤å¤‡ä»½"""
    backup_file = BACKUP_DIR / name
    if not backup_file.exists():
        return jsonify({"success": False, "error": "Backup not found"}), 404

    shutil.copy2(backup_file, CONFIG_FILE)
    reload_clash()
    emit_log(f"Restored from backup: {name}")
    return jsonify({"success": True})


@app.route('/api/backups/<name>', methods=['DELETE'])
def delete_backup(name):
    """åˆ é™¤å¤‡ä»½"""
    backup_file = BACKUP_DIR / name
    if backup_file.exists():
        backup_file.unlink()
    return jsonify({"success": True})


# ==========================================
#  API: Clash çŠ¶æ€
# ==========================================

@app.route('/api/clash/status', methods=['GET'])
def clash_status():
    """è·å– Clash è¿è¡ŒçŠ¶æ€"""
    try:
        headers = {"Authorization": f"Bearer {CLASH_SECRET}"} if CLASH_SECRET else {}
        resp = requests.get(f"{CLASH_API}", headers=headers, timeout=3)
        info = resp.json()

        # è·å–æµé‡ä¿¡æ¯
        try:
            traffic = requests.get(f"{CLASH_API}/traffic", headers=headers, timeout=1, stream=True)
            line = next(traffic.iter_lines())
            traffic_data = json.loads(line)
        except:
            traffic_data = {"up": 0, "down": 0}

        # è·å–è¿æ¥æ•°
        try:
            conns = requests.get(f"{CLASH_API}/connections", headers=headers, timeout=3)
            conn_data = conns.json()
            active_connections = len(conn_data.get("connections", []))
        except:
            active_connections = 0

        return jsonify({
            "success": True,
            "running": True,
            "version": info.get("version", "unknown"),
            "mode": info.get("mode", "unknown"),
            "upload": traffic_data.get("up", 0),
            "download": traffic_data.get("down", 0),
            "active_connections": active_connections
        })
    except:
        return jsonify({"success": True, "running": False})


# ==========================================
#  API: å®æ—¶æ—¥å¿— (SSE)
# ==========================================

@app.route('/api/logs/stream')
def log_stream():
    """SSE å®æ—¶æ—¥å¿—æµ"""
    def generate():
        q = queue.Queue(maxsize=100)
        log_queues.append(q)
        try:
            # å…ˆå‘é€å†å²
            for entry in log_history[-20:]:
                yield f"data: {json.dumps(entry)}\n\n"

            while True:
                try:
                    entry = q.get(timeout=30)
                    yield f"data: {json.dumps(entry)}\n\n"
                except queue.Empty:
                    yield ": heartbeat\n\n"
        finally:
            log_queues.remove(q)

    return Response(
        stream_with_context(generate()),
        content_type='text/event-stream',
        headers={
            'Cache-Control': 'no-cache',
            'X-Accel-Buffering': 'no'
        }
    )


@app.route('/api/logs', methods=['GET'])
def get_logs():
    """è·å–æ—¥å¿—å†å²"""
    return jsonify({"success": True, "data": log_history[-100:]})


# ==========================================
#  API: æ–‡ä»¶æµè§ˆ (é€šç”¨ç¼–è¾‘)
# ==========================================

EDITABLE_FILES = {
    "override": OVERRIDE_FILE,
    "template": TEMPLATE_FILE,
    "merge_script": SCRIPTS_DIR / "merge.py",
    "subscriptions": SUBS_CONFIG,
    "config": CONFIG_FILE,
}


@app.route('/api/files', methods=['GET'])
def list_files():
    """åˆ—å‡ºå¯ç¼–è¾‘æ–‡ä»¶"""
    files = []
    for key, path in EDITABLE_FILES.items():
        files.append({
            "key": key,
            "path": str(path),
            "exists": path.exists(),
            "size": path.stat().st_size if path.exists() else 0,
            "modified": datetime.fromtimestamp(path.stat().st_mtime).strftime(
                "%Y-%m-%d %H:%M:%S") if path.exists() else None
        })
    return jsonify({"success": True, "data": files})


@app.route('/api/files/<key>', methods=['GET'])
def get_file(key):
    """è¯»å–æ–‡ä»¶å†…å®¹"""
    path = EDITABLE_FILES.get(key)
    if not path:
        return jsonify({"success": False, "error": "Unknown file"}), 404
    content = read_text(path)
    return jsonify({"success": True, "content": content, "path": str(path)})


@app.route('/api/files/<key>', methods=['PUT'])
def save_file(key):
    """ä¿å­˜æ–‡ä»¶å†…å®¹"""
    path = EDITABLE_FILES.get(key)
    if not path:
        return jsonify({"success": False, "error": "Unknown file"}), 404

    body = request.json
    content = body.get("content", "")

    # æ ¹æ®æ–‡ä»¶ç±»å‹åšéªŒè¯
    if str(path).endswith('.yaml') or str(path).endswith('.yml'):
        try:
            yaml.safe_load(content)
        except yaml.YAMLError as e:
            return jsonify({"success": False, "error": f"YAML error: {e}"}), 400
    elif str(path).endswith('.json'):
        try:
            json.loads(content)
        except json.JSONDecodeError as e:
            return jsonify({"success": False, "error": f"JSON error: {e}"}), 400
    elif str(path).endswith('.py'):
        try:
            compile(content, path.name, "exec")
        except SyntaxError as e:
            return jsonify({"success": False, "error": f"Python error: {e}"}), 400

    # å¤‡ä»½
    if path.exists():
        backup = path.parent / f"{path.name}.bak"
        shutil.copy2(path, backup)

    write_text(content, path)
    emit_log(f"File saved: {key} ({path.name})")
    return jsonify({"success": True})


# ==========================================
if __name__ == '__main__':
    emit_log("Management API starting...")
    app.run(host='0.0.0.0', port=9092, debug=False, threaded=True)
```

---

## 6. å‰ç«¯ç®¡ç†é¢æ¿

### index.html

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clash è®¢é˜…ç®¡ç†é¢æ¿</title>
    <link rel="stylesheet" href="style.css">
    <!-- CodeMirror ä»£ç ç¼–è¾‘å™¨ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/theme/dracula.min.css">
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/yaml/yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/python/python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/javascript/javascript.min.js"></script>
</head>
<body>
    <div id="app">
        <!-- å¤´éƒ¨ -->
        <header class="header">
            <div class="header-left">
                <h1>âš¡ Clash Meta ç®¡ç†é¢æ¿</h1>
            </div>
            <div class="header-right">
                <span id="clash-status" class="status-badge offline">ç¦»çº¿</span>
                <span id="clash-version"></span>
                <a href="/clash-ui/" target="_blank" class="btn btn-sm">èŠ‚ç‚¹åˆ‡æ¢ UI â†’</a>
            </div>
        </header>

        <!-- çŠ¶æ€å¡ç‰‡ -->
        <div class="status-cards">
            <div class="card stat-card">
                <div class="stat-icon">ğŸŒ</div>
                <div class="stat-info">
                    <div class="stat-value" id="stat-proxies">0</div>
                    <div class="stat-label">æ€»èŠ‚ç‚¹æ•°</div>
                </div>
            </div>
            <div class="card stat-card">
                <div class="stat-icon">ğŸ“‚</div>
                <div class="stat-info">
                    <div class="stat-value" id="stat-groups">0</div>
                    <div class="stat-label">ä»£ç†ç»„</div>
                </div>
            </div>
            <div class="card stat-card">
                <div class="stat-icon">ğŸ“‹</div>
                <div class="stat-info">
                    <div class="stat-value" id="stat-rules">0</div>
                    <div class="stat-label">è§„åˆ™æ•°</div>
                </div>
            </div>
            <div class="card stat-card">
                <div class="stat-icon">ğŸ”—</div>
                <div class="stat-info">
                    <div class="stat-value" id="stat-conns">0</div>
                    <div class="stat-label">æ´»è·ƒè¿æ¥</div>
                </div>
            </div>
        </div>

        <!-- å¯¼èˆªæ ‡ç­¾ -->
        <nav class="tabs">
            <button class="tab active" data-tab="subscriptions">ğŸ“¡ è®¢é˜…ç®¡ç†</button>
            <button class="tab" data-tab="override">âš™ï¸ è¦†ç›–è§„åˆ™</button>
            <button class="tab" data-tab="editor">ğŸ“ è„šæœ¬ç¼–è¾‘</button>
            <button class="tab" data-tab="config">ğŸ“„ å½“å‰é…ç½®</button>
            <button class="tab" data-tab="backups">ğŸ’¾ å¤‡ä»½ç®¡ç†</button>
            <button class="tab" data-tab="logs">ğŸ“‹ å®æ—¶æ—¥å¿—</button>
        </nav>

        <!-- ========== è®¢é˜…ç®¡ç† ========== -->
        <div class="tab-content active" id="tab-subscriptions">
            <div class="toolbar">
                <button class="btn btn-primary" onclick="showAddSubModal()">â• æ·»åŠ è®¢é˜…</button>
                <button class="btn btn-success" onclick="doMerge()">ğŸ”„ æ‹‰å–å¹¶åˆå¹¶</button>
                <button class="btn" onclick="doReload()">â™»ï¸ é‡è½½é…ç½®</button>
                <button class="btn" onclick="loadSubscriptions()">ğŸ”ƒ åˆ·æ–°åˆ—è¡¨</button>
            </div>

            <div id="sub-list" class="sub-list">
                <!-- åŠ¨æ€å¡«å…… -->
            </div>
        </div>

        <!-- ========== è¦†ç›–è§„åˆ™ ========== -->
        <div class="tab-content" id="tab-override">
            <div class="toolbar">
                <button class="btn btn-primary" onclick="saveOverride()">ğŸ’¾ ä¿å­˜è¦†ç›–è§„åˆ™</button>
                <button class="btn" onclick="validateOverride()">âœ… éªŒè¯ YAML</button>
                <button class="btn btn-success" onclick="saveOverride().then(doMerge)">ğŸ’¾ ä¿å­˜å¹¶åˆå¹¶</button>
                <span id="override-status" class="toolbar-status"></span>
            </div>
            <div class="editor-info">
                <p>ç¼–è¾‘è¦†ç›–è§„åˆ™ï¼šè¿™é‡Œå®šä¹‰çš„å†…å®¹ä¼šè¦†ç›–/åˆå¹¶åˆ°æœ€ç»ˆé…ç½®ä¸­ï¼ŒåŒ…æ‹¬åŸºç¡€è®¾ç½®ã€ä»£ç†ç»„ã€è§„åˆ™ç­‰ã€‚</p>
            </div>
            <div id="override-editor" class="code-editor"></div>
        </div>

        <!-- ========== è„šæœ¬ç¼–è¾‘å™¨ ========== -->
        <div class="tab-content" id="tab-editor">
            <div class="toolbar">
                <select id="file-selector" onchange="loadFile()">
                    <option value="">-- é€‰æ‹©æ–‡ä»¶ --</option>
                </select>
                <button class="btn btn-primary" onclick="saveCurrentFile()">ğŸ’¾ ä¿å­˜æ–‡ä»¶</button>
                <button class="btn" onclick="validateCurrentFile()">âœ… è¯­æ³•æ£€æŸ¥</button>
                <span id="file-status" class="toolbar-status"></span>
            </div>
            <div id="file-info" class="editor-info"></div>
            <div id="file-editor" class="code-editor"></div>
        </div>

        <!-- ========== å½“å‰é…ç½® ========== -->
        <div class="tab-content" id="tab-config">
            <div class="toolbar">
                <button class="btn" onclick="loadConfig()">ğŸ”ƒ åˆ·æ–°</button>
                <button class="btn" onclick="doTestConfig()">ğŸ§ª æµ‹è¯•é…ç½®</button>
                <span id="config-status" class="toolbar-status"></span>
            </div>
            <div id="config-summary" class="config-summary"></div>
            <div id="config-editor" class="code-editor"></div>
        </div>

        <!-- ========== å¤‡ä»½ç®¡ç† ========== -->
        <div class="tab-content" id="tab-backups">
            <div class="toolbar">
                <button class="btn btn-primary" onclick="createBackup()">ğŸ“¸ åˆ›å»ºå¤‡ä»½</button>
                <button class="btn" onclick="loadBackups()">ğŸ”ƒ åˆ·æ–°</button>
            </div>
            <div id="backup-list" class="backup-list"></div>
        </div>

        <!-- ========== å®æ—¶æ—¥å¿— ========== -->
        <div class="tab-content" id="tab-logs">
            <div class="toolbar">
                <button class="btn" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©º</button>
                <label><input type="checkbox" id="log-autoscroll" checked> è‡ªåŠ¨æ»šåŠ¨</label>
                <label>
                    è¿‡æ»¤:
                    <select id="log-filter">
                        <option value="">å…¨éƒ¨</option>
                        <option value="INFO">INFO</option>
                        <option value="WARN">WARN</option>
                        <option value="ERROR">ERROR</option>
                        <option value="SUCCESS">SUCCESS</option>
                    </select>
                </label>
            </div>
            <div id="log-container" class="log-container"></div>
        </div>

        <!-- æ·»åŠ è®¢é˜…å¼¹çª— -->
        <div id="modal-overlay" class="modal-overlay" style="display:none;">
            <div class="modal">
                <div class="modal-header">
                    <h3 id="modal-title">æ·»åŠ è®¢é˜…</h3>
                    <button class="modal-close" onclick="closeModal()">âœ•</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="sub-edit-original-name">
                    <div class="form-group">
                        <label>åç§° *</label>
                        <input type="text" id="sub-name" placeholder="å¦‚: Airport-A">
                    </div>
                    <div class="form-group">
                        <label>è®¢é˜…åœ°å€ *</label>
                        <input type="text" id="sub-url" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>å‰ç¼€</label>
                        <input type="text" id="sub-prefix" placeholder="A_">
                        <small>æ·»åŠ åˆ°èŠ‚ç‚¹åç§°å‰ï¼Œä¾¿äºåŒºåˆ†æ¥æº</small>
                    </div>
                    <div class="form-group">
                        <label>æ’é™¤è¿‡æ»¤ (æ­£åˆ™)</label>
                        <input type="text" id="sub-exclude" placeholder="(?i)(è¿‡æœŸ|å‰©ä½™|å®˜ç½‘)" 
                               value="(?i)(è¿‡æœŸ|å‰©ä½™|å®˜ç½‘|æµé‡)">
                    </div>
                    <div class="form-group">
                        <label>åŒ…å«è¿‡æ»¤ (æ­£åˆ™, ç•™ç©º=å…¨éƒ¨)</label>
                        <input type="text" id="sub-include" placeholder="">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="submitSubscription()">ç¡®è®¤</button>
                </div>
            </div>
        </div>

        <!-- èŠ‚ç‚¹åˆ—è¡¨å¼¹çª— -->
        <div id="nodes-modal" class="modal-overlay" style="display:none;">
            <div class="modal modal-lg">
                <div class="modal-header">
                    <h3 id="nodes-modal-title">èŠ‚ç‚¹åˆ—è¡¨</h3>
                    <button class="modal-close" onclick="closeNodesModal()">âœ•</button>
                </div>
                <div class="modal-body">
                    <div id="nodes-list" class="nodes-list"></div>
                </div>
            </div>
        </div>

        <!-- Toast é€šçŸ¥ -->
        <div id="toast-container" class="toast-container"></div>
    </div>

    <script src="app.js"></script>
</body>
</html>
```

### style.css

```css
/* style.css */
:root {
    --bg-primary: #0f1923;
    --bg-secondary: #1a2332;
    --bg-tertiary: #243044;
    --bg-card: #1e2d3d;
    --text-primary: #e4e9f0;
    --text-secondary: #8899aa;
    --accent: #4fc3f7;
    --accent-hover: #29b6f6;
    --success: #66bb6a;
    --warning: #ffa726;
    --danger: #ef5350;
    --border: #2d3f50;
    --shadow: 0 2px 8px rgba(0,0,0,0.3);
    --radius: 8px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
}

#app {
    max-width: 1400px;
    margin: 0 auto;
    padding: 16px;
}

/* Header */
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    background: var(--bg-secondary);
    border-radius: var(--radius);
    margin-bottom: 16px;
    border: 1px solid var(--border);
}

.header h1 { font-size: 1.3em; }
.header-right { display: flex; align-items: center; gap: 12px; }

.status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: 600;
}

.status-badge.online { background: var(--success); color: #fff; }
.status-badge.offline { background: var(--danger); color: #fff; }

/* Status Cards */
.status-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
    margin-bottom: 16px;
}

.stat-card {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px;
}

.stat-icon { font-size: 2em; }
.stat-value { font-size: 1.8em; font-weight: 700; color: var(--accent); }
.stat-label { color: var(--text-secondary); font-size: 0.85em; margin-top: 2px; }

/* Card */
.card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
}

/* Tabs */
.tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 16px;
    background: var(--bg-secondary);
    padding: 6px;
    border-radius: var(--radius);
    overflow-x: auto;
}

.tab {
    padding: 10px 20px;
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    border-radius: 6px;
    font-size: 0.9em;
    white-space: nowrap;
    transition: all 0.2s;
}

.tab:hover { background: var(--bg-tertiary); color: var(--text-primary); }
.tab.active { background: var(--accent); color: #fff; }

.tab-content { display: none; }
.tab-content.active { display: block; }

/* Toolbar */
.toolbar {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 16px;
    padding: 12px 16px;
    background: var(--bg-secondary);
    border-radius: var(--radius);
    border: 1px solid var(--border);
}

.toolbar select {
    padding: 8px 12px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    color: var(--text-primary);
    border-radius: 6px;
    font-size: 0.9em;
}

.toolbar-status {
    margin-left: auto;
    font-size: 0.85em;
    padding: 4px 10px;
    border-radius: 4px;
}

/* Buttons */
.btn {
    padding: 8px 16px;
    border: 1px solid var(--border);
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85em;
    background: var(--bg-tertiary);
    color: var(--text-primary);
    transition: all 0.2s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.btn:hover { background: var(--border); }
.btn-sm { padding: 4px 10px; font-size: 0.8em; }
.btn-primary { background: var(--accent); color: #fff; border-color: var(--accent); }
.btn-primary:hover { background: var(--accent-hover); }
.btn-success { background: var(--success); color: #fff; border-color: var(--success); }
.btn-danger { background: var(--danger); color: #fff; border-color: var(--danger); }
.btn-warning { background: var(--warning); color: #333; border-color: var(--warning); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* Subscription List */
.sub-list { display: flex; flex-direction: column; gap: 10px; }

.sub-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px 20px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    transition: border-color 0.2s;
}

.sub-item:hover { border-color: var(--accent); }
.sub-item.disabled { opacity: 0.5; }

.sub-toggle {
    width: 44px; height: 24px;
    background: var(--bg-tertiary);
    border-radius: 12px;
    position: relative;
    cursor: pointer;
    border: 2px solid var(--border);
    transition: all 0.3s;
    flex-shrink: 0;
}

.sub-toggle.active { background: var(--success); border-color: var(--success); }

.sub-toggle::after {
    content: '';
    width: 18px; height: 18px;
    background: white;
    border-radius: 50%;
    position: absolute;
    top: 1px; left: 1px;
    transition: transform 0.3s;
}

.sub-toggle.active::after { transform: translateX(20px); }

.sub-info { flex: 1; min-width: 0; }
.sub-name { font-weight: 600; font-size: 1.05em; margin-bottom: 4px; }

.sub-meta {
    display: flex;
    gap: 16px;
    color: var(--text-secondary);
    font-size: 0.8em;
    flex-wrap: wrap;
}

.sub-meta span { display: flex; align-items: center; gap: 4px; }
.sub-actions { display: flex; gap: 6px; flex-shrink: 0; }

/* Code Editor */
.code-editor {
    height: 600px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
}

.CodeMirror {
    height: 100% !important;
    font-family: 'Fira Code', 'Monaco', 'Menlo', monospace;
    font-size: 13px;
}

.editor-info {
    padding: 10px 16px;
    margin-bottom: 10px;
    background: var(--bg-secondary);
    border-radius: var(--radius);
    border-left: 3px solid var(--accent);
    font-size: 0.85em;
    color: var(--text-secondary);
}

/* Config Summary */
.config-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 10px;
    margin-bottom: 16px;
}

.summary-item {
    padding: 12px 16px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
}

/* Log Container */
.log-container {
    height: 500px;
    overflow-y: auto;
    background: #0a0e14;
    border-radius: var(--radius);
    padding: 12px;
    font-family: 'Fira Code', monospace;
    font-size: 12px;
    line-height: 1.6;
    border: 1px solid var(--border);
}

.log-entry { padding: 2px 0; white-space: pre-wrap; word-break: break-all; }
.log-entry .time { color: #5c6773; }
.log-entry .level-INFO { color: var(--accent); }
.log-entry .level-WARN { color: var(--warning); }
.log-entry .level-ERROR { color: var(--danger); }
.log-entry .level-SUCCESS { color: var(--success); }

/* Backup List */
.backup-list { display: flex; flex-direction: column; gap: 8px; }

.backup-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
}

.backup-info { display: flex; gap: 20px; align-items: center; }
.backup-name { font-weight: 500; }
.backup-meta { color: var(--text-secondary); font-size: 0.85em; }

/* Nodes List */
.nodes-list {
    max-height: 500px;
    overflow-y: auto;
}

.node-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    font-size: 0.9em;
}

.node-item:nth-child(odd) { background: var(--bg-tertiary); }
.node-type { 
    padding: 2px 8px;
    background: var(--accent);
    color: #fff;
    border-radius: 4px;
    font-size: 0.75em;
    font-weight: 600;
}

/* Modal */
.modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
}

.modal {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 12px;
    width: 90%;
    max-width: 540px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

.modal-lg { max-width: 800px; }

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
}

.modal-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 1.2em;
    cursor: pointer;
}

.modal-body { padding: 20px; }
.modal-footer {
    padding: 12px 20px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 8px;
}

.form-group { margin-bottom: 16px; }
.form-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.9em; }
.form-group small { display: block; margin-top: 4px; color: var(--text-secondary); font-size: 0.8em; }

.form-group input[type="text"] {
    width: 100%;
    padding: 10px 12px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-primary);
    font-size: 0.9em;
}

.form-group input:focus {
    outline: none;
    border-color: var(--accent);
}

/* Toast */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 2000;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.toast {
    padding: 12px 20px;
    border-radius: 8px;
    color: #fff;
    font-size: 0.9em;
    animation: slideIn 0.3s ease;
    max-width: 400px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}

.toast.success { background: var(--success); }
.toast.error { background: var(--danger); }
.toast.warning { background: var(--warning); color: #333; }
.toast.info { background: var(--accent); }

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* å“åº”å¼ */
@media (max-width: 768px) {
    .header { flex-direction: column; gap: 10px; }
    .sub-item { flex-direction: column; align-items: flex-start; }
    .sub-actions { width: 100%; justify-content: flex-end; }
    .status-cards { grid-template-columns: repeat(2, 1fr); }
    .tabs { flex-wrap: nowrap; }
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg-primary); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
```

### app.js

```javascript
// app.js - ç®¡ç†é¢æ¿å‰ç«¯é€»è¾‘

const API = '/api';
let editors = {};
let currentFileKey = '';
let logEventSource = null;

// ==========================================
//  å·¥å…·å‡½æ•°
// ==========================================

async function api(path, options = {}) {
    const url = `${API}${path}`;
    const config = {
        headers: { 'Content-Type': 'application/json' },
        ...options
    };
    if (config.body && typeof config.body === 'object') {
        config.body = JSON.stringify(config.body);
    }
    const resp = await fetch(url, config);
    const data = await resp.json();
    if (!resp.ok && !data.success) {
        throw new Error(data.error || `HTTP ${resp.status}`);
    }
    return data;
}

function toast(msg, type = 'info', duration = 3000) {
    const container = document.getElementById('toast-container');
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.textContent = msg;
    container.appendChild(el);
    setTimeout(() => el.remove(), duration);
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// ==========================================
//  æ ‡ç­¾åˆ‡æ¢
// ==========================================

document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        const target = tab.dataset.tab;
        document.getElementById(`tab-${target}`).classList.add('active');

        // æ‡’åŠ è½½
        switch (target) {
            case 'subscriptions': loadSubscriptions(); break;
            case 'override': initOverrideEditor(); break;
            case 'editor': initFileEditor(); break;
            case 'config': loadConfig(); break;
            case 'backups': loadBackups(); break;
            case 'logs': initLogStream(); break;
        }
    });
});

// ==========================================
//  çŠ¶æ€åˆ·æ–°
// ==========================================

async function refreshStatus() {
    try {
        // Clash çŠ¶æ€
        const status = await api('/clash/status');
        const badge = document.getElementById('clash-status');
        const version = document.getElementById('clash-version');

        if (status.running) {
            badge.className = 'status-badge online';
            badge.textContent = 'è¿è¡Œä¸­';
            version.textContent = `v${status.version} | ${status.mode}`;
            document.getElementById('stat-conns').textContent = status.active_connections;
        } else {
            badge.className = 'status-badge offline';
            badge.textContent = 'ç¦»çº¿';
        }

        // é…ç½®æ¦‚è¦
        const summary = await api('/config/summary');
        if (summary.success) {
            document.getElementById('stat-proxies').textContent = summary.data.proxy_count;
            document.getElementById('stat-groups').textContent = summary.data.group_count;
            document.getElementById('stat-rules').textContent = summary.data.rule_count;
        }
    } catch (e) {
        console.error('Status refresh failed:', e);
    }
}

setInterval(refreshStatus, 5000);
refreshStatus();

// ==========================================
//  è®¢é˜…ç®¡ç†
// ==========================================

async function loadSubscriptions() {
    try {
        const result = await api('/subscriptions');
        const list = document.getElementById('sub-list');

        if (!result.data || result.data.length === 0) {
            list.innerHTML = `
                <div class="card" style="padding:40px;text-align:center;color:var(--text-secondary)">
                    <p style="font-size:2em;margin-bottom:10px">ğŸ“¡</p>
                    <p>æš‚æ— è®¢é˜…ï¼Œç‚¹å‡»ä¸Šæ–¹"æ·»åŠ è®¢é˜…"å¼€å§‹</p>
                </div>`;
            return;
        }

        list.innerHTML = result.data.map(sub => `
            <div class="sub-item ${sub.enabled ? '' : 'disabled'}">
                <div class="sub-toggle ${sub.enabled ? 'active' : ''}" 
                     onclick="toggleSub('${sub.name}')"></div>
                <div class="sub-info">
                    <div class="sub-name">${sub.name}</div>
                    <div class="sub-meta">
                        <span>ğŸ·ï¸ å‰ç¼€: ${sub.prefix || 'æ— '}</span>
                        <span>ğŸ“Š èŠ‚ç‚¹: ${sub.node_count || 0}</span>
                        ${sub.cached ? `<span>â±ï¸ æ›´æ–°: ${sub.cached_time}</span>` : '<span>âš ï¸ æœªç¼“å­˜</span>'}
                    </div>
                </div>
                <div class="sub-actions">
                    <button class="btn btn-sm" onclick="testSub('${sub.name}')" title="æµ‹è¯•">ğŸ§ª</button>
                    <button class="btn btn-sm" onclick="viewNodes('${sub.name}')" title="æŸ¥çœ‹èŠ‚ç‚¹">ğŸ‘ï¸</button>
                    <button class="btn btn-sm" onclick="editSub('${sub.name}')" title="ç¼–è¾‘">âœï¸</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteSub('${sub.name}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
                </div>
            </div>
        `).join('');
    } catch (e) {
        toast('åŠ è½½è®¢é˜…å¤±è´¥: ' + e.message, 'error');
    }
}

function showAddSubModal() {
    document.getElementById('modal-title').textContent = 'æ·»åŠ è®¢é˜…';
    document.getElementById('sub-edit-original-name').value = '';
    document.getElementById('sub-name').value = '';
    document.getElementById('sub-url').value = '';
    document.getElementById('sub-prefix').value = '';
    document.getElementById('sub-exclude').value = '(?i)(è¿‡æœŸ|å‰©ä½™|å®˜ç½‘|æµé‡)';
    document.getElementById('sub-include').value = '';
    document.getElementById('sub-name').disabled = false;
    document.getElementById('modal-overlay').style.display = 'flex';
}

async function editSub(name) {
    try {
        const result = await api('/subscriptions');
        const sub = result.data.find(s => s.name === name);
        if (!sub) return;

        document.getElementById('modal-title').textContent = 'ç¼–è¾‘è®¢é˜…';
        document.getElementById('sub-edit-original-name').value = name;
        document.getElementById('sub-name').value = sub.name;
        document.getElementById('sub-name').disabled = true;
        document.getElementById('sub-url').value = sub.url;
        document.getElementById('sub-prefix').value = sub.prefix || '';
        document.getElementById('sub-exclude').value = sub.exclude_filter || '';
        document.getElementById('sub-include').value = sub.include_filter || '';
        document.getElementById('modal-overlay').style.display = 'flex';
    } catch (e) {
        toast('åŠ è½½è®¢é˜…ä¿¡æ¯å¤±è´¥', 'error');
    }
}

function closeModal() {
    document.getElementById('modal-overlay').style.display = 'none';
}

async function submitSubscription() {
    const originalName = document.getElementById('sub-edit-original-name').value;
    const name = document.getElementById('sub-name').value.trim();
    const url = document.getElementById('sub-url').value.trim();
    const prefix = document.getElementById('sub-prefix').value.trim();
    const exclude = document.getElementById('sub-exclude').value.trim();
    const include = document.getElementById('sub-include').value.trim();

    if (!name || !url) {
        toast('åç§°å’Œåœ°å€ä¸èƒ½ä¸ºç©º', 'warning');
        return;
    }

    try {
        const body = {
            name, url, prefix,
            exclude_filter: exclude,
            include_filter: include,
            enabled: true
        };

        if (originalName) {
            // ç¼–è¾‘æ¨¡å¼
            await api(`/subscriptions/${originalName}`, {
                method: 'PUT',
                body: { ...body, url, prefix, exclude_filter: exclude, include_filter: include }
            });
            toast('è®¢é˜…å·²æ›´æ–°', 'success');
        } else {
            // æ·»åŠ æ¨¡å¼
            await api('/subscriptions', { method: 'POST', body });
            toast('è®¢é˜…å·²æ·»åŠ ', 'success');
        }

        closeModal();
        loadSubscriptions();
    } catch (e) {
        toast('æ“ä½œå¤±è´¥: ' + e.message, 'error');
    }
}

async function toggleSub(name) {
    try {
        const result = await api(`/subscriptions/${name}/toggle`, { method: 'POST' });
        toast(`${name} å·²${result.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`, 'success');
        loadSubscriptions();
    } catch (e) {
        toast('åˆ‡æ¢å¤±è´¥', 'error');
    }
}

async function deleteSub(name) {
    if (!confirm(`ç¡®å®šåˆ é™¤è®¢é˜… "${name}"ï¼Ÿ`)) return;
    try {
        await api(`/subscriptions/${name}`, { method: 'DELETE' });
        toast('è®¢é˜…å·²åˆ é™¤', 'success');
        loadSubscriptions();
    } catch (e) {
        toast('åˆ é™¤å¤±è´¥', 'error');
    }
}

async function testSub(name) {
    toast(`æ­£åœ¨æµ‹è¯• ${name}...`, 'info');
    try {
        const result = await api(`/subscriptions/${name}/test`, { method: 'POST' });
        if (result.success) {
            toast(`${name}: æ‰¾åˆ° ${result.node_count} ä¸ªèŠ‚ç‚¹`, 'success');
        } else {
            toast(`æµ‹è¯•å¤±è´¥: ${result.error}`, 'error');
        }
    } catch (e) {
        toast('æµ‹è¯•å¤±è´¥: ' + e.message, 'error');
    }
}

async function viewNodes(name) {
    try {
        const result = await api(`/subscriptions/${name}/nodes`);
        document.getElementById('nodes-modal-title').textContent = `${name} - ${result.total} ä¸ªèŠ‚ç‚¹`;

        document.getElementById('nodes-list').innerHTML = result.data.map(n => `
            <div class="node-item">
                <span>${n.name}</span>
                <span>
                    <span class="node-type">${n.type}</span>
                    ${n.server}:${n.port}
                </span>
            </div>
        `).join('');

        document.getElementById('nodes-modal').style.display = 'flex';
    } catch (e) {
        toast('åŠ è½½èŠ‚ç‚¹å¤±è´¥: ' + e.message, 'error');
    }
}

function closeNodesModal() {
    document.getElementById('nodes-modal').style.display = 'none';
}

// ==========================================
//  æ“ä½œæŒ‰é’®
// ==========================================

async function doMerge() {
    try {
        await api('/actions/merge', { method: 'POST' });
        toast('åˆå¹¶ä»»åŠ¡å·²å¯åŠ¨ï¼ŒæŸ¥çœ‹æ—¥å¿—äº†è§£è¿›åº¦', 'info');
        // è‡ªåŠ¨è·³åˆ°æ—¥å¿—é¡µ
        document.querySelector('[data-tab="logs"]').click();
    } catch (e) {
        toast('å¯åŠ¨åˆå¹¶å¤±è´¥: ' + e.message, 'error');
    }
}

async function doReload() {
    try {
        const result = await api('/actions/reload', { method: 'POST' });
        toast(result.success ? 'é…ç½®å·²é‡è½½' : 'é‡è½½å¤±è´¥', result.success ? 'success' : 'error');
        refreshStatus();
    } catch (e) {
        toast('é‡è½½å¤±è´¥: ' + e.message, 'error');
    }
}

async function doTestConfig() {
    try {
        const result = await api('/actions/test-config', { method: 'POST' });
        const status = document.getElementById('config-status');
        if (result.valid) {
            status.textContent = 'âœ… é…ç½®æœ‰æ•ˆ';
            status.style.color = 'var(--success)';
            toast('é…ç½®éªŒè¯é€šè¿‡', 'success');
        } else {
            status.textContent = 'âŒ é…ç½®æœ‰è¯¯';
            status.style.color = 'var(--danger)';
            toast('é…ç½®éªŒè¯å¤±è´¥:\n' + result.output, 'error', 5000);
        }
    } catch (e) {
        toast('æµ‹è¯•å¤±è´¥', 'error');
    }
}

// ==========================================
//  è¦†ç›–è§„åˆ™ç¼–è¾‘å™¨
// ==========================================

let overrideEditorInit = false;

async function initOverrideEditor() {
    if (!overrideEditorInit) {
        editors.override = CodeMirror(document.getElementById('override-editor'), {
            mode: 'yaml',
            theme: 'dracula',
            lineNumbers: true,
            lineWrapping: true,
            tabSize: 2,
            indentWithTabs: false,
            matchBrackets: true,
            autoCloseBrackets: true,
        });
        overrideEditorInit = true;
    }

    try {
        const result = await api('/override');
        editors.override.setValue(result.content || '# è¦†ç›–è§„åˆ™\n');
    } catch (e) {
        toast('åŠ è½½è¦†ç›–è§„åˆ™å¤±è´¥', 'error');
    }
}

async function saveOverride() {
    try {
        const content = editors.override.getValue();
        await api('/override', { method: 'PUT', body: { content } });
        toast('è¦†ç›–è§„åˆ™å·²ä¿å­˜', 'success');
        document.getElementById('override-status').textContent = 'âœ… å·²ä¿å­˜';
        document.getElementById('override-status').style.color = 'var(--success)';
    } catch (e) {
        toast('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
        document.getElementById('override-status').textContent = 'âŒ ' + e.message;
        document.getElementById('override-status').style.color = 'var(--danger)';
    }
}

async function validateOverride() {
    try {
        const content = editors.override.getValue();
        const result = await api('/override/validate', { method: 'POST', body: { content } });
        if (result.valid) {
            toast(`YAML æœ‰æ•ˆï¼ŒåŒ…å« keys: ${result.keys.join(', ')}`, 'success');
        } else {
            toast('YAML é”™è¯¯: ' + result.error, 'error', 5000);
        }
    } catch (e) {
        toast('éªŒè¯å¤±è´¥', 'error');
    }
}

// ==========================================
//  é€šç”¨æ–‡ä»¶ç¼–è¾‘å™¨
// ==========================================

let fileEditorInit = false;

async function initFileEditor() {
    if (!fileEditorInit) {
        editors.file = CodeMirror(document.getElementById('file-editor'), {
            mode: 'yaml',
            theme: 'dracula',
            lineNumbers: true,
            lineWrapping: true,
            tabSize: 2,
            indentWithTabs: false,
        });
        fileEditorInit = true;
    }

    // åŠ è½½æ–‡ä»¶åˆ—è¡¨
    try {
        const result = await api('/files');
        const selector = document.getElementById('file-selector');
        const modeMap = {
            'override': 'yaml',
            'template': 'yaml',
            'merge_script': 'python',
            'subscriptions': 'javascript',
            'config': 'yaml'
        };
        const labelMap = {
            'override': 'âš™ï¸ è¦†ç›–è§„åˆ™ (override.yaml)',
            'template': 'ğŸ“‹ åŸºç¡€æ¨¡æ¿ (template.yaml)',
            'merge_script': 'ğŸ åˆå¹¶è„šæœ¬ (merge.py)',
            'subscriptions': 'ğŸ“¡ è®¢é˜…é…ç½® (subscriptions.json)',
            'config': 'ğŸ“„ å½“å‰é…ç½® (config.yaml) [åªè¯»æ¨è]'
        };

        selector.innerHTML = '<option value="">-- é€‰æ‹©æ–‡ä»¶ --</option>';
        result.data.forEach(f => {
            const opt = document.createElement('option');
            opt.value = f.key;
            opt.textContent = labelMap[f.key] || f.key;
            opt.dataset.mode = modeMap[f.key] || 'yaml';
            selector.appendChild(opt);
        });
    } catch (e) {
        toast('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥', 'error');
    }
}

async function loadFile() {
    const selector = document.getElementById('file-selector');
    const key = selector.value;
    if (!key) return;

    currentFileKey = key;

    try {
        const result = await api(`/files/${key}`);
        const mode = selector.selectedOptions[0].dataset.mode || 'yaml';
        editors.file.setOption('mode', mode);
        editors.file.setValue(result.content || '');

        document.getElementById('file-info').innerHTML =
            `<strong>æ–‡ä»¶:</strong> ${result.path} | <strong>æ¨¡å¼:</strong> ${mode}`;
        document.getElementById('file-status').textContent = '';
    } catch (e) {
        toast('åŠ è½½æ–‡ä»¶å¤±è´¥', 'error');
    }
}

async function saveCurrentFile() {
    if (!currentFileKey) {
        toast('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'warning');
        return;
    }

    try {
        const content = editors.file.getValue();
        await api(`/files/${currentFileKey}`, {
            method: 'PUT',
            body: { content }
        });
        toast('æ–‡ä»¶å·²ä¿å­˜', 'success');
        document.getElementById('file-status').textContent = 'âœ… å·²ä¿å­˜';
        document.getElementById('file-status').style.color = 'var(--success)';
    } catch (e) {
        toast('ä¿å­˜å¤±è´¥: ' + e.message, 'error', 5000);
        document.getElementById('file-status').textContent = 'âŒ ' + e.message;
        document.getElementById('file-status').style.color = 'var(--danger)';
    }
}

function validateCurrentFile() {
    if (!currentFileKey) return;
    const content = editors.file.getValue();
    const selector = document.getElementById('file-selector');
    const mode = selector.selectedOptions[0]?.dataset.mode || 'yaml';

    try {
        if (mode === 'python') {
            // ç®€å•çš„è¯­æ³•æç¤ºï¼ˆå®é™…éªŒè¯åœ¨åç«¯ï¼‰
            toast('Python è¯­æ³•å°†åœ¨ä¿å­˜æ—¶ç”±åç«¯éªŒè¯', 'info');
        } else if (mode === 'javascript') {
            JSON.parse(content);
            toast('JSON æ ¼å¼æ­£ç¡®', 'success');
        } else {
            // YAML å‰ç«¯ç®€å•æ ¡éªŒ
            toast('YAML æ ¼å¼å°†åœ¨ä¿å­˜æ—¶ç”±åç«¯éªŒè¯', 'info');
        }
    } catch (e) {
        toast('è¯­æ³•é”™è¯¯: ' + e.message, 'error');
    }
}

// ==========================================
//  å½“å‰é…ç½®æŸ¥çœ‹
// ==========================================

let configEditorInit = false;

async function loadConfig() {
    if (!configEditorInit) {
        editors.config = CodeMirror(document.getElementById('config-editor'), {
            mode: 'yaml',
            theme: 'dracula',
            lineNumbers: true,
            lineWrapping: true,
            readOnly: true,
            tabSize: 2,
        });
        configEditorInit = true;
    }

    try {
        const [configResult, summaryResult] = await Promise.all([
            api('/config'),
            api('/config/summary')
        ]);

        editors.config.setValue(configResult.content || '');

        if (summaryResult.success) {
            const d = summaryResult.data;
            const typeHtml = Object.entries(d.proxy_types || {})
                .map(([k, v]) => `<span class="node-type">${k}: ${v}</span>`).join(' ');

            document.getElementById('config-summary').innerHTML = `
                <div class="summary-item">
                    <strong>ğŸ“Š èŠ‚ç‚¹ç»Ÿè®¡:</strong> ${d.proxy_count} ä¸ªèŠ‚ç‚¹ ${typeHtml}
                </div>
                <div class="summary-item">
                    <strong>ğŸ“‚ ä»£ç†ç»„:</strong> ${d.groups.map(g => `${g.name}(${g.type})`).join(', ')}
                </div>
                <div class="summary-item">
                    <strong>ğŸŒ æ¨¡å¼:</strong> ${d.mode} | <strong>ç«¯å£:</strong> ${d.port}
                </div>
            `;
        }
    } catch (e) {
        toast('åŠ è½½é…ç½®å¤±è´¥', 'error');
    }
}

// ==========================================
//  å¤‡ä»½ç®¡ç†
// ==========================================

async function loadBackups() {
    try {
        const result = await api('/backups');
        const list = document.getElementById('backup-list');

        if (!result.data || result.data.length === 0) {
            list.innerHTML = '<div class="card" style="padding:30px;text-align:center;color:var(--text-secondary)">æš‚æ— å¤‡ä»½</div>';
            return;
        }

        list.innerHTML = result.data.map(b => `
            <div class="backup-item">
                <div class="backup-info">
                    <span class="backup-name">ğŸ“ ${b.name}</span>
                    <span class="backup-meta">${b.time} Â· ${formatBytes(b.size)}</span>
                </div>
                <div style="display:flex;gap:6px;">
                    <button class="btn btn-sm btn-warning" onclick="restoreBackup('${b.name}')">æ¢å¤</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteBackup('${b.name}')">åˆ é™¤</button>
                </div>
            </div>
        `).join('');
    } catch (e) {
        toast('åŠ è½½å¤‡ä»½å¤±è´¥', 'error');
    }
}

async function createBackup() {
    try {
        const result = await api('/backups', { method: 'POST' });
        toast(`å¤‡ä»½å·²åˆ›å»º: ${result.name}`, 'success');
        loadBackups();
    } catch (e) {
        toast('åˆ›å»ºå¤‡ä»½å¤±è´¥', 'error');
    }
}

async function restoreBackup(name) {
    if (!confirm(`ç¡®å®šä» "${name}" æ¢å¤ï¼Ÿå½“å‰é…ç½®å°†è¢«è¦†ç›–ã€‚`)) return;
    try {
        await api(`/backups/${name}/restore`, { method: 'POST' });
        toast('å·²ä»å¤‡ä»½æ¢å¤', 'success');
        refreshStatus();
    } catch (e) {
        toast('æ¢å¤å¤±è´¥', 'error');
    }
}

async function deleteBackup(name) {
    if (!confirm(`ç¡®å®šåˆ é™¤å¤‡ä»½ "${name}"ï¼Ÿ`)) return;
    try {
        await api(`/backups/${name}`, { method: 'DELETE' });
        toast('å¤‡ä»½å·²åˆ é™¤', 'success');
        loadBackups();
    } catch (e) {
        toast('åˆ é™¤å¤±è´¥', 'error');
    }
}

// ==========================================
//  å®æ—¶æ—¥å¿— (SSE)
// ==========================================

let logStreamInit = false;

function initLogStream() {
    if (logStreamInit) return;
    logStreamInit = true;

    const container = document.getElementById('log-container');

    logEventSource = new EventSource('/api/logs/stream');

    logEventSource.onmessage = function (event) {
        const entry = JSON.parse(event.data);
        const filter = document.getElementById('log-filter').value;

        if (filter && entry.level !== filter) return;

        const el = document.createElement('div');
        el.className = 'log-entry';
        el.innerHTML = `<span class="time">${entry.time}</span> <span class="level-${entry.level}">[${entry.level}]</span> ${escapeHtml(entry.msg)}`;
        container.appendChild(el);

        // é™åˆ¶æ˜¾ç¤ºè¡Œæ•°
        while (container.children.length > 500) {
            container.removeChild(container.firstChild);
        }

        // è‡ªåŠ¨æ»šåŠ¨
        if (document.getElementById('log-autoscroll').checked) {
            container.scrollTop = container.scrollHeight;
        }
    };

    logEventSource.onerror = function () {
        setTimeout(() => {
            logStreamInit = false;
            initLogStream();
        }, 3000);
    };
}

function clearLogs() {
    document.getElementById('log-container').innerHTML = '';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// æ—¥å¿—è¿‡æ»¤å™¨å˜åŒ–æ—¶æ¸…ç©ºé‡æ–°è¿æ¥
document.getElementById('log-filter')?.addEventListener('change', () => {
    clearLogs();
});

// ==========================================
//  åˆå§‹åŠ è½½
// ==========================================

loadSubscriptions();
```

---

## éƒ¨ç½²ä¸ä½¿ç”¨

```bash
# æ„å»ºå¯åŠ¨
docker-compose up -d --build

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f
```

### è®¿é—®åœ°å€

| åœ°å€ | åŠŸèƒ½ |
|------|------|
| `http://IP:80` | **ç®¡ç†é¢æ¿**ï¼ˆè®¢é˜…ç®¡ç†ã€è„šæœ¬ç¼–è¾‘ã€æ—¥å¿—ï¼‰ |
| `http://IP:80/clash-ui/` | **metacubexd**ï¼ˆèŠ‚ç‚¹åˆ‡æ¢ã€è¿æ¥æŸ¥çœ‹ï¼‰ |
| `http://IP:7890` | HTTP ä»£ç† |
| `http://IP:7891` | SOCKS5 ä»£ç† |

### ç®¡ç†é¢æ¿åŠŸèƒ½æˆªå›¾æè¿°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš¡ Clash Meta ç®¡ç†é¢æ¿              ğŸŸ¢ è¿è¡Œä¸­ v1.18  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸŒ   â”‚ ğŸ“‚   â”‚ ğŸ“‹   â”‚ ğŸ”—   â”‚      â”‚                  â”‚
â”‚ 128  â”‚  8   â”‚ 256  â”‚ 42   â”‚      â”‚                  â”‚
â”‚ èŠ‚ç‚¹ â”‚ åˆ†ç»„ â”‚ è§„åˆ™ â”‚ è¿æ¥  â”‚      â”‚                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ğŸ“¡è®¢é˜…ç®¡ç†] [âš™ï¸è¦†ç›–è§„åˆ™] [ğŸ“è„šæœ¬ç¼–è¾‘] [ğŸ“‹æ—¥å¿—]      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â•æ·»åŠ è®¢é˜…  ğŸ”„æ‹‰å–å¹¶åˆå¹¶  â™»ï¸é‡è½½é…ç½®                  â”‚
â”‚                                                     â”‚
â”‚ â”Œâ”€ âœ… Airport-A â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ğŸ§ª ğŸ‘ï¸ âœï¸ ğŸ—‘ï¸ â”€â”€â” â”‚
â”‚ â”‚   ğŸ·ï¸ A_  ğŸ“Š 56èŠ‚ç‚¹  â±ï¸ 2024-01-15 10:30        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€ âœ… Airport-B â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ğŸ§ª ğŸ‘ï¸ âœï¸ ğŸ—‘ï¸ â”€â”€â” â”‚
â”‚ â”‚   ğŸ·ï¸ B_  ğŸ“Š 72èŠ‚ç‚¹  â±ï¸ 2024-01-15 10:30        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€ âŒ Airport-C (å·²ç¦ç”¨)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ğŸ§ª ğŸ‘ï¸ âœï¸ ğŸ—‘ï¸ â”€â”€â” â”‚
â”‚ â”‚   ğŸ·ï¸ C_  ğŸ“Š 30èŠ‚ç‚¹  â±ï¸ 2024-01-14 08:00        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é¢æ¿æ ¸å¿ƒåŠŸèƒ½æ€»ç»“

| Tab | åŠŸèƒ½ |
|-----|------|
| **ğŸ“¡ è®¢é˜…ç®¡ç†** | æ·»åŠ /åˆ é™¤/å¯ç”¨ç¦ç”¨/æµ‹è¯•/æŸ¥çœ‹èŠ‚ç‚¹ï¼Œä¸€é”®åˆå¹¶ |
| **âš™ï¸ è¦†ç›–è§„åˆ™** | å¯è§†åŒ–ç¼–è¾‘ override.yamlï¼ˆä»£ç†ç»„ã€è§„åˆ™ã€DNS ç­‰ï¼‰ |
| **ğŸ“ è„šæœ¬ç¼–è¾‘** | åœ¨çº¿ç¼–è¾‘ merge.py / template.yaml / subscriptions.json ç­‰æ‰€æœ‰é…ç½®æ–‡ä»¶ï¼Œå¸¦è¯­æ³•é«˜äº®å’ŒéªŒè¯ |
| **ğŸ“„ å½“å‰é…ç½®** | æŸ¥çœ‹æœ€ç»ˆç”Ÿæˆçš„ config.yamlï¼Œé…ç½®æ‘˜è¦ç»Ÿè®¡ |
| **ğŸ’¾ å¤‡ä»½ç®¡ç†** | æ‰‹åŠ¨/è‡ªåŠ¨å¤‡ä»½ï¼Œä¸€é”®æ¢å¤ |
| **ğŸ“‹ å®æ—¶æ—¥å¿—** | SSE å®æ—¶æ¨é€åˆå¹¶è¿‡ç¨‹æ—¥å¿—ï¼Œæ”¯æŒè¿‡æ»¤ |