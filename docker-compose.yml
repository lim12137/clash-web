version: "3.8"

services:
  clash:
    build:
      context: .
      args:
        TARGETARCH: amd64
    container_name: clash-meta-manager
    restart: unless-stopped
    ports:
      - "80:80"
      - "17890:17890"
      - "7891:7891"
    volumes:
      - ./config:/root/.config/mihomo
      - ./scripts:/scripts
      - ./web:/web
    environment:
      TZ: Asia/Shanghai
      CLASH_SECRET: ${CLASH_SECRET:-}
      ADMIN_TOKEN: ${ADMIN_TOKEN:-}
      API_PORT: ${API_PORT:-19092}
      PYTHON_BIN: /usr/bin/python3
    cap_add:
      - NET_ADMIN
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://127.0.0.1/api/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
